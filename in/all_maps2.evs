#memory(
    string_key(0x0546)..string_key(0x232b), // last half of string keys
    function_key(0x0000)..function_key(0x1716), // 0x1719 seems to be used by the engine 

    0x300000..0x3fffff, // extension

    // reserved: <0x23b9>
    <0x2272>..<0x2558>,

    <0x2834>..<0x28ff>
)
#include("in/core.evs")

#patch(
    // "void_maps",

    "skip_intro",
    // "brian",
    // "camera_hack",
    // "free_graveyard_ids",
    // "save_file_growth",

    // asm
    // "debug_menu", // uses 0x3f0000…???
    "_hook_input", // 0x3f0000…0x310000
        "hotkeys", // uses 0x3f00000…???
        // "room_timer", // uses 0x300000…???
    // "_hook_trigger",
)

// hotkeys

@install()
@inject(ADDRESS.HOTKEY_START)
fun hotkey_start() {
    debug_subtext("Start");
}
@install()
@inject(ADDRESS.HOTKEY_START_L)
fun hotkey_start_l() {
    debug_subtext("Start+L");

    if(True) {
        <0x2834> += 0x01;
    } else if(False) {
        MEMORY.MAP_PALETTE += 0d1;
    }
}
@install()
@inject(ADDRESS.HOTKEY_START_R)
fun hotkey_start_r() {
    debug_subtext("Start+R");

    if((<ACTIVE>[FLAGS_2] & ATTRIBUTE_FLAGS.NO_CLIP) == 0d0) {
        attribute(ACTIVE, NO_CLIP, True);
    } else {
        attribute(ACTIVE, NO_CLIP, False);
    }

    debug_boy();
    // attribute(ACTIVE, INVINCIBLE_TEMP, True);
    <ACTIVE>[HP] = SYSTEM.HP_MAX;
    unlock(JAGUAR_RING);
}

// helper

fun test_objects() {
    <0x2834> = 0x00;
    while(True) {
        <0x2836> = 0x00;
        while(<0x2836> < 0d3) {
            debug_memory(<0x2834>, <0x2836>);
            object[<0x2834>] = <0x2836>;
            sleep(0x50);
            <0x2836> += 0x01;
        }
        debug_memory(<0x2834>, 0x7e);
        object[<0x2834>] = 0x7e;
        sleep(0x50);
    }
}

// maps

@install(ADDRESS.INTRO_FIRST_CODE_EXECUTED)
fun intro_skip() {
    // act 3
    // map_transition(footknight, east, NONE);
    // map_transition(dark_forest_room_3, north, NONE);
    // map_transition(bad_boys, east, NONE);
    // map_transition(timberdrake, south, NONE);
    // map_transition(verminator, south, NONE);
    // map_transition(sterling, south, NONE);
    // map_transition(mungola, east_2, NONE);

    // act 4
    // map_transition(face, south, NONE);
    // map_transition(carltron, center, NONE);

    // misc
    // map_transition(brians_room, center, NONE);

    map_transition(professors_lab, east, NONE);
}

// act 3

map well(WELL) {
    enum entrance {
        west = entrance(0x01, 0x1c, EAST)
    }

    enum stepon_trigger {
        exit_west = @install() {
            debug_subtext("S=0");
        },
    }

    enum b_trigger {
        well = @install() {
            debug_subtext("B=0");
        },
    }

    fun trigger_enter() {
        fade_in();
    }
};

map gate(GATE) {
    enum entrance {
        north = entrance(0x2c, 0x09, SOUTH),
        east = entrance(0x67, 0x71, WEST),
    }

    enum stepon_trigger {
        stepon_0 = @install() {
            debug_subtext("S=0");
        },
        stepon_1 = @install() {
            debug_subtext("S=1");
        },
    }

    enum b_trigger {
        sniff__1_ash_1 = @install() {
            debug_subtext("B=0");
            _loot(0x13, ASH, 0d01, 0d01);
        },
        sniff__1_ash_1 = @install() {
            debug_subtext("B=1");
            _loot(0x12, ASH, 0d01, 0d01);
        },
        sniff__1_ethanol_1 = @install() {
            debug_subtext("B=2");
            _loot(0x11, ETHANOL, 0d01, 0d01);
        },
        sniff__1_roots_1 = @install() {
            debug_subtext("B=3");
            _loot(0x10, ROOTS, 0d01, 0d01);
        },
        sniff__1_roots_1 = @install() {
            debug_subtext("B=4");
            _loot(0x0f, ROOTS, 0d01, 0d01);
        },
        sniff__1_water_1 = @install() {
            debug_subtext("B=5");
            _loot(0x0e, WATER, 0d01, 0d01);
        },
        sniff__1_brimstone_1 = @install() {
            debug_subtext("B=6");
            _loot(0x0d, BRIMSTONE, 0d01, 0d01);
        },
        sniff__1_feather_1 = @install() {
            debug_subtext("B=7");
            _loot(0x0c, FEATHER, 0d01, 0d01);
        },
        sniff__1_feather_1 = @install() {
            debug_subtext("B=8");
            _loot(0x0b, FEATHER, 0d01, 0d01);
        },
        sniff__1_mushroom_1 = @install() {
            debug_subtext("B=9");
            _loot(0x0a, MUSHROOM, 0d01, 0d01);
        },

        sniff__1_mushroom_1 = @install() {
            debug_subtext("B=10");
            _loot(0x09, MUSHROOM, 0d01, 0d01);
        },
        sniff__1_mushroom_1 = @install() {
            debug_subtext("B=11");
            _loot(0x08, MUSHROOM, 0d01, 0d01);
        },
        sniff__1_acorns_1 = @install() {
            debug_subtext("B=12");
            _loot(0x07, ACORNS, 0d01, 0d01);
        },
        sniff__1_acorns_1 = @install() {
            debug_subtext("B=13");
            _loot(0x06, ACORNS, 0d01, 0d01);
        },
        sniff__1_iron_1 = @install() {
            debug_subtext("B=14");
            _loot(0x05, IRON, 0d01, 0d01);
        },
        sniff__1_iron_1 = @install() {
            debug_subtext("B=15");
            _loot(0x04, IRON, 0d01, 0d01);
        },
        gourd_x__aura_formula = @install() {
            debug_subtext("B=16");
            // aura formula
        },
        gourd_x__1_anihilation_amulet = @install() {
            debug_subtext("B=17");
            _loot_chest(0x01, ANNIHILATION_AMULET, 0d01);
        },
        gourd_x__5_ash = @install() {
            debug_subtext("B=18");
            _loot_chest(0x02, ASH, 0d05);
        },
        gourd_x__1_atlas_medallion = @install() {
            debug_subtext("B=19");
            _loot_chest(0x03, ATLAS_MEDALLION, 0d01);
        },
    }

    fun trigger_enter() {
        fade_in();
    }
};

map market_west(IVOR_MARKET) {
    enum entrance {
        north = entrance(0x2a, 0x01, SOUTH),
        east = entrance(0x39, 0xc3, WEST),
    }

    enum stepon_trigger {
        exit_north = @install() {
            debug_subtext("S=0");
        },
        exit_east = @install() {
            debug_subtext("S=1");
        },
    }

    fun trigger_enter() {
        // init_map(0x0, 0x0, 0x39, 0xc3); // cutscene: pig race
        init_map(0x0, 0x0, 0x3a, 0xcc);

        fade_in();
    }
};

map trailers(IVOR_TRAILERS_EXTERIOR) {
    enum entrance {
        test = entrance(0x54, 0x4b, NORTH),

        south = entrance(0x54, 0x4b, NORTH),

        trailer_1 = entrance(0x14, 0x1b, SOUTH),
        trailer_2 = entrance(0x32, 0x15, SOUTH),
        trailer_3 = entrance(0x43, 0x1b, SOUTH),
    }

    enum stepon_trigger {
        before_wagon_2_1 = @install() {
            debug_subtext("S=0");
        },
        before_wagon_2_2 = @install() {
            debug_subtext("S=1");
        },
        before_wagon_2_3 = @install() {
            debug_subtext("S=2");
        },
        before_wagon_2_4 = @install() {
            debug_subtext("S=3");
        },
        before_wagon_2_5 = @install() {
            debug_subtext("S=4");
        },
        exit_south = @install() {
            debug_subtext("S=5");
        },
        exit_wagon_2 = @install() {
            debug_subtext("S=6");
        },
        exit_wagon_1 = @install() {
            debug_subtext("S=7");
        },
        exit_wagon_3 = @install() {
            debug_subtext("S=8");
        },
    }

    fun trigger_enter() {
        // object[0x00] = 0x01; // open door_1
        // object[0x01] = 0x01; // open door_2
        // object[0x02] = 0x01; // open door_3

        fade_in();
    }
};

map trailers_inside(IVOR_TRAILERS_INTERIOR) {
    enum entrance {
        wagon_2_south = entrance(0x1c, 0x17, NONE),

        wagon_1_center = entrance(0x4c, 0x27, NONE),
    }

    enum stepon_trigger {
        exit_wagon_2_south = @install() {
            debug_subtext("S=0");
        },
        exit_wagon_1_south = @install() {
            debug_subtext("S=1");
        },
    }

    fun trigger_enter() {
        // object[0x00] = 0x7e; // open curtain_1
        // object[0x01] = 0x7e; // open curtain_2
        // object[0x02] = 0x7e; // open curtain_3
        // object[0x03] = 0x7e; // open curtain_4

        fade_in();
    }
};

map tower_bottom_half(IVOR_EBON_1) {
    enum entrance {
        north = entrance(0x20, 0x01, SOUTH),
        south = entrance(0x1c, 0x5f, NORTH),
        west = entrance(0x01, 0x3e, EAST),

        door_1 = entrance(0x2a, 0x01, SOUTH),
        door_2 = entrance(0x2a, 0x01, SOUTH),
        door_3 = entrance(0x2a, 0x01, SOUTH),
        door_4 = entrance(0x2a, 0x01, SOUTH),
        door_5 = entrance(0x2a, 0x01, SOUTH),
    }

    enum stepon_trigger {
        door_1_1_back = @install() {
            debug_subtext("S=0");
        },
        exit_west = @install() {
            debug_subtext("S=1");
        },
        exit_north = @install() {
            debug_subtext("S=2");
        },
        exit_south = @install() {
            debug_subtext("S=3");
        },
        door_1_1 = @install() {
            debug_subtext("S=4");
        },
        door_2_1 = @install() {
            debug_subtext("S=5");
        },
        door_2_2 = @install() {
            debug_subtext("S=6");
        },
        door_2_3 = @install() {
            debug_subtext("S=7");
        },
    }

    enum b_trigger {
        b_trigger_0 = @install() {
            debug_subtext("B=0");
        },
        b_trigger_1 = @install() {
            debug_subtext("B=1");
        },
        b_trigger_2 = @install() {
            debug_subtext("B=2");
        },
        b_trigger_3 = @install() {
            debug_subtext("B=3");
        },
        b_trigger_4 = @install() {
            debug_subtext("B=4");
        },
        b_trigger_5 = @install() {
            debug_subtext("B=5");
        },
        b_trigger_6 = @install() {
            debug_subtext("B=6");
        },
    }

    fun block_market(block) {
        if(block) {
            object[0x1a] = 0x01;
        }  else {
            object[0x1a] = 0x00;
        }
    }

    fun trigger_enter() {
        fade_in();

        // MEMORY.MAP_PALETTE = 0x07;

        // object[0x00] = 0x02; // change door_2_3 (closed, open, barricaded)
        // object[0x01] = 0x02; // change door_2_2 (closed, open, barricaded)
        // object[0x02] = 0x02; // change door_2_1 (closed, open, barricaded)
        // object[0x03] = 0x02; // change door_1_1 (closed, open, barricaded)
        // object[0x04] = 0x01; // close gate_south
        // object[0x05] = 0x01; // replace gate_north_flower_1 (scrub)
        // object[0x06] = 0x01; // replace gate_north_flower_2 (scrub)
        // object[0x07] = 0x01; // replace gate_north_flower_3 (scrub)
        // object[0x08] = 0x01; // replace gate_north_flower_4 (scrub)
        // object[0x09] = 0x01; // replace house_2_2_flower_1 (scrub)
        // object[0x0a] = 0x01; // replace house_2_2_flower_2 (scrub)
        // object[0x0b] = 0x01; // replace house_2_3_flower (scrub)
        // object[0x0c] = 0x01; // replace stairs_lower_flower_2 (scrub)
        // object[0x0d] = 0x01; // replace stairs_lower_flower_1 (scrub)
        // object[0x0e] = 0x01; // replace stairs_lower_flower_3 (scrub)
        // object[0x0f] = 0x01; // replace house_1_1_flower (scrub)
        // object[0x10] = 0x01; // replace market_flower_bed_2_3 (scrub)
        // object[0x11] = 0x01; // replace market_flower_bed_2_2 (scrub)
        // object[0x12] = 0x01; // replace market_flower_bed_2_1 (scrub)
        // object[0x13] = 0x01; // replace market_flower_bed_1_3 (scrub)
        // object[0x14] = 0x01; // replace market_flower_bed_1_2 (scrub)
        // object[0x15] = 0x01; // replace market_flower_bed_1_1 (scrub)
        // object[0x16] = 0x01; // replace market_flower_4 (scrub)
        // object[0x17] = 0x01; // replace market_flower_3 (scrub)
        // object[0x18] = 0x01; // replace market_flower_2 (scrub)
        // object[0x19] = 0x01; // replace market_flower_1 (scrub)
        // object[0x1a] = 0x01; // block exit_west
        // object[0x1b] = 0x01; // open door_1_1_back
    }
};

map tower_houses(IVOR_EBON_HOUSES) {
    enum entrance {
        door_house_1 = entrance(0xca, 0x53, NORTH),

        door_house_2 = entrance(0x72, 0x79, NORTH),
        stairs_house_2 = entrance(0x58, 0x67, SOUTH),

        door_house_3 = entrance(0x70, 0x47, NORTH),
        stairs_house_3 = entrance(0x56, 0x35, SOUTH),

        door_inn_1_left = entrance(0x10, 0x8b, NORTH),
        door_inn_1_right = entrance(0x38, 0x8b, NORTH),

        door_inn_2_left = entrance(0x10, 0x47, NORTH),
        door_inn_2_right = entrance(0x38, 0x47, NORTH),

        stairs_upstairs = entrance(0xaa, 0x23, NORTH),

        door_backroom_2chests = entrance(0x8c, 0x10, SOUTH),
        
        door_backroom_3chests = entrance(0x50, 0x0c, SOUTH),
    }

    enum stepon_trigger {
        exit_backroom_3chests = @install() {
            debug_subtext("S=0");
        },
        exit_inn_2_left = @install() {
            debug_subtext("S=1");
        },
        exit_inn_2_right = @install() {
            debug_subtext("S=2");
        },
        exit_stairs_house_3 = @install() {
            debug_subtext("S=3");
        },
        exit_door_house_3 = @install() {
            debug_subtext("S=4");
        },
        exit_stairs_upstairs = @install() {
            debug_subtext("S=5");
        },
        exit_house_1 = @install() {
            debug_subtext("S=6");
        },
        exit_door_house_2 = @install() {
            debug_subtext("S=7");
        },
        exit_stairs_house_2 = @install() {
            debug_subtext("S=8");
        },
        exit_backroom_2chests = @install() {
            debug_subtext("S=9");
        },

        exit_inn_1_left = @install() {
            debug_subtext("S=10");
        },
        exit_inn_1_right = @install() {
            debug_subtext("S=11");
        },
    }

    enum b_trigger {
        gourd_backroom_3chests_3 = @install() {
            debug_subtext("B=0");
            _loot_chest(0x03, LIMESTONE, 0d03);
            // _loot_chest(0x03, ACORNS, 0d03);
        },
        gourd_backroom_3chests_2 = @install() {
            debug_subtext("B=1");
            _loot_chest(0x02, FEATHER, 0d01);
            // _loot_chest(0x02, MONEY, 0d100);
        },
        gourd_backroom_3chests_1 = @install() {
            debug_subtext("B=2");
            _loot_chest(0x01, MONEY, 0d50);
            // _loot_chest(0x01, ANNIHILATION_AMULET, 0d01);
        },
        gourd_inn_2 = @install() {
            debug_subtext("B=3");
            _loot_chest(0x00, CALL_BEADS, 0d03);
            // _loot_chest(0x00, BRIMSTONE, 0d03);
        },
        gourd_house_2 = @install() {
            debug_subtext("B=4");
            _loot_chest(0x0c, IRON, 0d05);
            // _loot_chest(0x0c, PETAL, 0d01);
            // _loot_chest(0x0c, ETHANOL, 0d03);
            // _loot_chest(0x0c, NECTAR, 0d04);
        },
        gourd_house_3_north = @install() {
            debug_subtext("B=5");
            _loot_chest(0x04, ETHANOL, 0d03);
            // _loot_chest(0x04, ASH, 0d06);
        },
        gourd_house_3_east = @install() {
            debug_subtext("B=6");
            _loot_chest(0x0b, CRYSTAL, 0d01);
            // _loot_chest(0x0b, LIMESTONE, 0d01);
        },
        gourd_backroom_2chests_2 = @install() {
            debug_subtext("B=7");
            _loot_chest(0x06, LIMESTONE, 0d02);
            // _loot_chest(0x06, ANNIHILATION_AMULET, 0d01);
        },
        gourd_backroom_2chests_1 = @install() {
            debug_subtext("B=8");
            _loot_chest(0x05, VINEGAR, 0d03);
            // _loot_chest(0x05, BISCUIT, 0d01);
        },
        gourd_upstairs_1 = @install() {
            debug_subtext("B=9");
            _loot_chest(0x07, WAX, 0d03);
            // _loot_chest(0x07, WATER, 0d06);
            // _loot_chest(0x07, BRIMSTONE, 0d02);
            // _loot_chest(0x07, CHEST_3_2, 0d01);
            // _loot_chest(0x07, VINEGAR, 0d06);
            // _loot_chest(0x07, ETHANOL, 0d03);
        },

        gourd_upstairs_2 = @install() {
            debug_subtext("B=10");
            _loot_chest(0x08, ASH, 0d08);
            // _loot_chest(0x08, VINEGAR, 0d04);
            // _loot_chest(0x08, NECTAR, 0d01);
            // _loot_chest(0x08, ANNIHILATION_AMULET, 0d01);
            // _loot_chest(0x08, WATER, 0d06);
            // _loot_chest(0x08, ASH, 0d06);
        },
        gourd_house_1_west = @install() {
            debug_subtext("B=11");
            _loot_chest(0x0a, HONEY, 0d01);
            // _loot_chest(0x08, ACORNS, 0d02);
            // _loot_chest(0x08, WAX, 0d04);
            // _loot_chest(0x08, ETHANOL, 0d04);
            // _loot_chest(0x08, ATLAS_MEDALLION, 0d01);
            // _loot_chest(0x08, BRIMSTONE, 0d01);
            // _loot_chest(0x08, BONE, 0d02);
            // _loot_chest(0x08, MUSHROOM, 0d01);
        },
        gourd_house_1_north = @install() {
            debug_subtext("B=12");
            _loot_chest(0x09, MUSHROOM, 0d01);
            // _loot_chest(0x09, MONEY, 0d20);
            // _loot_chest(0x09, ETHANOL, 0d02);
            // _loot_chest(0x09, BONE, 0d02);
            // _loot_chest(0x09, CRYSTAL, 0d10);
            // _loot_chest(0x09, ETHANOL, 0d03);
            // _loot_chest(0x09, ROOTS, 0d07);
            // _loot_chest(0x09, CLAY, 0d04);
        },
        inn_inn_2_south = @install() {
            debug_subtext("B=13");
        },
        inn_inn_2_east = @install() {
            debug_subtext("B=14");
        },
        inn_inn_1_east = @install() {
            debug_subtext("B=15");
        },
        inn_inn_1_south = @install() {
            debug_subtext("B=16");
        },
        gourd_inn_1 = @install() {
            debug_subtext("B=17");
            _loot_chest(0x1f, HONEY, 0d02);
        },
        vendor_inn_1_south = @install() {
            debug_subtext("B=18");
        },
        vendor_inn_1_east = @install() {
            debug_subtext("B=19");
        },

        gourd_x = @install() {
            debug_subtext("B=20");
            _loot_chest(0x1a, WATER, 0d01);
        },
    }

    fun init_room(index) {
        if(index == 0x00) {
            init_map(0xa2, 0x24, 0xd8, 0x54); // house_1
        } else if(index == 0x00) {
            init_map(0x4a, 0x48, 0x9c, 0x7a); // house_2
        } else if(index == 0x00) {
            init_map(0x48, 0x08, 0x9a, 0x48); // house_3
        } else if(index == 0x00) {
            init_map(0x02, 0x4c, 0x46, 0x8c); // inn_1
        } else if(index == 0x00) {
            init_map(0x02, 0x08, 0x46, 0x48); // inn_2
        } else if(index == 0x00) {
            init_map(0xa2, 0x08, 0xd4, 0x24); // upstairs
        }
    }

    fun trigger_enter() {
        fade_in();
        
        // init_map(0xa2, 0x24, 0xd8, 0x54); // house_1
        // init_map(0x4a, 0x48, 0x9c, 0x7a); // house_2
        // init_map(0x48, 0x08, 0x9a, 0x48); // house_3
        // init_map(0x02, 0x4c, 0x46, 0x8c); // inn_1
        // init_map(0x02, 0x08, 0x46, 0x48); // inn_2
        // init_map(0xa2, 0x08, 0xd4, 0x24); // upstairs

        // object[0x09] = 0x01; // open gourd_house_1_north
        // object[0x0a] = 0x01; // open gourd_house_1_west

        // object[0x0c] = 0x01; // open gourd_house_2

        // object[0x04] = 0x01; // open gourd_house_3_north
        // object[0x0b] = 0x01; // open gourd_house_3_east

        // object[0x1f] = 0x01; // open gourd_inn_1

        // object[0x00] = 0x01; // open gourd_inn_2

        // object[0x07] = 0x01; // open gourd_upstairs_1
        // object[0x08] = 0x01; // open gourd_upstairs_2
        // object[0x1a] = 0x01; // change upstairs_layout (0 = bed, 1 = chest closed, wall pass through 2 = chest open, wall closed)
        // object[0x1b] = 0x01; // show wall_upstairs
        // object[0x1c] = 0x01; // show cosmetic_upstairs_1 (crate instead of bed)
        // object[0x1d] = 0x01; // show cosmetic_upstairs_2 (fruit bowl)
        // object[0x1e] = 0x01; // hide cosmetic_upstairs_2 (clock)

        // object[0x05] = 0x01; // open gourd_backroom_2chests_1
        // object[0x06] = 0x01; // open gourd_backroom_2chests_2

        // object[0x01] = 0x01; // open gourd_backroom_3chests_1
        // object[0x02] = 0x01; // open gourd_backroom_3chests_2
        // object[0x03] = 0x01; // open gourd_backroom_3chests_3

        // 0d-19 ???
    }
};
map tower_houses__house_1(IVOR_EBON_HOUSES) {
    enum entrance {
        door = entrance(0xca, 0x53, NORTH),
    }

    enum stepon_trigger {
        exit_backroom_3chests = nop(),
        exit_inn_2_left = nop(),
        exit_inn_2_right = nop(),
        exit_stairs_house_3 = nop(),
        exit_door_house_3 = nop(),
        exit_stairs_upstairs = nop(),
        exit_door = @install() {
            debug_subtext("S=6");
        },
        exit_door_house_2 = nop(),
        exit_stairs_house_2 = nop(),
        exit_backroom_2chests = nop(),

        exit_inn_1_left = nop(),
        exit_inn_1_right = nop(),
    }

    enum b_trigger {
        gourd_backroom_3chests_3 = nop(),
        gourd_backroom_3chests_2 = nop(),
        gourd_backroom_3chests_1 = nop(),
        gourd_inn_2 = nop(),
        gourd_house_2 = nop(),
        gourd_house_3_north = nop(),
        gourd_house_3_east = nop(),
        gourd_backroom_2chests_2 = nop(),
        gourd_backroom_2chests_1 = nop(),
        gourd_upstairs_1 = nop(),

        gourd_upstairs_2 = nop(),
        b_trigger_11 = @install() {
            debug_subtext("B=11");
        },
        b_trigger_12 = @install() {
            debug_subtext("B=12");
        },
        inn_inn_2_south = nop(),
        inn_inn_2_east = nop(),
        inn_inn_1_east = nop(),
        inn_inn_1_south = nop(),
        gourd_inn_1 = nop(),
        vendor_inn_1_south = nop(),
        vendor_inn_1_east = nop(),

        b_trigger_20 = @install() {
            debug_subtext("B=20");
        },
    }

    fun trigger_enter() {
        // object[0x09] = 0x01; // open gourd_house_1_north
        // object[0x0a] = 0x01; // open gourd_house_1_west

        fade_in();
    }
};
map tower_houses__house_2(IVOR_EBON_HOUSES) {
    enum entrance {
        door = entrance(0x72, 0x79, NORTH),
        stairs = entrance(0x58, 0x67, SOUTH),
    }

    enum stepon_trigger {
        exit_backroom_3chests = nop(),
        exit_inn_2_left = nop(),
        exit_inn_2_right = nop(),
        exit_stairs_house_3 = nop(),
        exit_door_house_3 = nop(),
        exit_stairs_upstairs = nop(),
        exit_house_1 = nop(),
        exit_door = @install() {
            debug_subtext("S=7");
        },
        exit_stairs = @install() {
            debug_subtext("S=8");
        },
        exit_backroom_2chests = nop(),

        exit_inn_1_left = nop(),
        exit_inn_1_right = nop(),
    }

    enum b_trigger {
        gourd_backroom_3chests_3 = nop(),
        gourd_backroom_3chests_2 = nop(),
        gourd_backroom_3chests_1 = nop(),
        gourd_inn_2 = nop(),
        gourd = @install() {
            debug_subtext("B=4");
        },
        gourd_house_3_north = nop(),
        gourd_house_3_east = nop(),
        gourd_backroom_2chests_2 = nop(),
        gourd_backroom_2chests_1 = nop(),
        gourd_upstairs_1 = nop(),

        gourd_upstairs_2 = nop(),
        b_trigger_11 = @install() {
            debug_subtext("B=11");
        },
        b_trigger_12 = @install() {
            debug_subtext("B=12");
        },
        inn_inn_2_south = nop(),
        inn_inn_2_east = nop(),
        inn_inn_1_east = nop(),
        inn_inn_1_south = nop(),
        gourd_inn_1 = nop(),
        vendor_inn_1_south = nop(),
        vendor_inn_1_east = nop(),

        b_trigger_20 = @install() {
            debug_subtext("B=20");
        },
    }

    fun trigger_enter() {
        // object[0x0c] = 0x01; // open gourd_house_2

        fade_in();
    }
};
map tower_houses__house_3(IVOR_EBON_HOUSES) {
    enum entrance {
        door = entrance(0x70, 0x47, NORTH),
        stairs = entrance(0x56, 0x35, SOUTH),
    }

    enum stepon_trigger {
        exit_backroom_3chests = nop(),
        exit_inn_2_left = nop(),
        exit_inn_2_right = nop(),
        exit_stairs_house_3 = @install() {
            debug_subtext("S=3");
        },
        exit_door_house_3 = @install() {
            debug_subtext("S=4");
        },
        exit_stairs_upstairs = nop(),
        exit_house_1 = nop(),
        exit_door_house_2 = nop(),
        exit_stairs_house_2 = nop(),
        exit_backroom_2chests = nop(),

        exit_inn_1_left = nop(),
        exit_inn_1_right = nop(),
    }

    enum b_trigger {
        gourd_backroom_3chests_3 = nop(),
        gourd_backroom_3chests_2 = nop(),
        gourd_backroom_3chests_1 = nop(),
        gourd_inn_2 = nop(),
        gourd_house_2 = nop(),
        gourd_north = @install() {
            debug_subtext("B=5");
        },
        gourd_east = @install() {
            debug_subtext("B=6");
        },
        gourd_backroom_2chests_2 = nop(),
        gourd_backroom_2chests_1 = nop(),
        gourd_upstairs_1 = nop(),

        gourd_upstairs_2 = nop(),
        b_trigger_11 = @install() {
            debug_subtext("B=11");
        },
        b_trigger_12 = @install() {
            debug_subtext("B=12");
        },
        inn_inn_2_south = nop(),
        inn_inn_2_east = nop(),
        inn_inn_1_east = nop(),
        inn_inn_1_south = nop(),
        gourd_inn_1 = nop(),
        vendor_inn_1_south = nop(),
        vendor_inn_1_east = nop(),

        b_trigger_20 = @install() {
            debug_subtext("B=20");
        },
    }

    fun trigger_enter() {
        // object[0x04] = 0x01; // open gourd_house_3_north
        // object[0x0b] = 0x01; // open gourd_house_3_east

        fade_in();
    }
};
map tower_houses__inn_1(IVOR_EBON_HOUSES) {
    enum entrance {
        door_left = entrance(0x10, 0x8b, NORTH),
        door_right = entrance(0x38, 0x8b, NORTH),
    }

    enum stepon_trigger {
        exit_backroom_3chests = nop(),
        exit_inn_2_left = nop(),
        exit_inn_2_right = nop(),
        exit_stairs_house_3 = nop(),
        exit_door_house_3 = nop(),
        exit_stairs_upstairs = nop(),
        exit_house_1 = nop(),
        exit_door_house_2 = nop(),
        exit_stairs_house_2 = nop(),
        exit_backroom_2chests = nop(),

        exit_door_left = @install() {
            debug_subtext("S=10");
        },
        exit_door_right = @install() {
            debug_subtext("S=11");
        },
    }

    enum b_trigger {
        gourd_backroom_3chests_3 = nop(),
        gourd_backroom_3chests_2 = nop(),
        gourd_backroom_3chests_1 = nop(),
        gourd_inn_2 = nop(),
        gourd_house_2 = nop(),
        gourd_house_3_north = nop(),
        gourd_house_3_east = nop(),
        gourd_backroom_2chests_2 = nop(),
        gourd_backroom_2chests_1 = nop(),
        gourd_upstairs_1 = nop(),

        gourd_upstairs_2 = nop(),
        b_trigger_11 = @install() {
            debug_subtext("B=11");
        },
        b_trigger_12 = @install() {
            debug_subtext("B=12");
        },
        inn_inn_2_south = nop(),
        inn_inn_2_east = nop(),
        inn_east = @install() {
            debug_subtext("B=15");
        },
        inn_south = @install() {
            debug_subtext("B=16");
        },
        gourd = @install() {
            debug_subtext("B=17");
        },
        vendor_south = @install() {
            debug_subtext("B=18");
        },
        vendor_east = @install() {
            debug_subtext("B=19");
        },

        b_trigger_20 = @install() {
            debug_subtext("B=20");
        },
    }

    fun trigger_enter() {
        // object[0x1f] = 0x01; // open gourd_inn_1

        fade_in();
    }
};
map tower_houses__inn_2(IVOR_EBON_HOUSES) {
    enum entrance {
        door_left = entrance(0x10, 0x47, NORTH),
        door_right = entrance(0x38, 0x47, NORTH),
    }

    enum stepon_trigger {
        exit_backroom_3chests = nop(),
        exit_inn_2_left = @install() {
            debug_subtext("S=1");
        },
        exit_inn_2_right = @install() {
            debug_subtext("S=2");
        },
        exit_stairs_house_3 = nop(),
        exit_door_house_3 = nop(),
        exit_stairs_upstairs = nop(),
        exit_house_1 = nop(),
        exit_door_house_2 = nop(),
        exit_stairs_house_2 = nop(),
        exit_backroom_2chests = nop(),

        exit_inn_1_left = nop(),
        exit_inn_1_right = nop(),
    }

    enum b_trigger {
        gourd_backroom_3chests_3 = nop(),
        gourd_backroom_3chests_2 = nop(),
        gourd_backroom_3chests_1 = nop(),
        gourd = @install() {
            debug_subtext("B=3");
        },
        gourd_house_2 = nop(),
        gourd_house_3_north = nop(),
        gourd_house_3_east = nop(),
        gourd_backroom_2chests_2 = nop(),
        gourd_backroom_2chests_1 = nop(),
        gourd_upstairs_1 = nop(),

        gourd_upstairs_2 = nop(),
        b_trigger_11 = @install() {
            debug_subtext("B=11");
        },
        b_trigger_12 = @install() {
            debug_subtext("B=12");
        },
        inn_south = @install() {
            debug_subtext("B=13");
        },
        inn_east = @install() {
            debug_subtext("B=14");
        },
        inn_inn_1_east = nop(),
        inn_inn_1_south = nop(),
        gourd_inn_1 = nop(),
        vendor_inn_1_south = nop(),
        vendor_inn_1_east = nop(),

        b_trigger_20 = @install() {
            debug_subtext("B=20");
        },
    }

    fun trigger_enter() {
        // object[0x00] = 0x01; // open gourd_inn_2

        fade_in();
    }
};
map tower_houses__upstairs(IVOR_EBON_HOUSES) {
    enum entrance {
        stairs_upstairs = entrance(0xaa, 0x23, NORTH),
    }

    enum stepon_trigger {
        exit_backroom_3chests = nop(),
        exit_inn_2_left = nop(),
        exit_inn_2_right = nop(),
        exit_stairs_house_3 = nop(),
        exit_door_house_3 = nop(),
        exit_stairs = @install() {
            debug_subtext("S=5");
        },
        exit_house_1 = nop(),
        exit_door_house_2 = nop(),
        exit_stairs_house_2 = nop(),
        exit_backroom_2chests = nop(),

        exit_inn_1_left = nop(),
        exit_inn_1_right = nop(),
    }

    enum b_trigger {
        gourd_backroom_3chests_3 = nop(),
        gourd_backroom_3chests_2 = nop(),
        gourd_backroom_3chests_1 = nop(),
        gourd_inn_2 = nop(),
        gourd_house_2 = nop(),
        gourd_house_3_north = nop(),
        gourd_house_3_east = nop(),
        gourd_backroom_2chests_2 = nop(),
        gourd_backroom_2chests_1 = nop(),
        gourd_1 = @install() {
            debug_subtext("B=9");
        },

        gourd_2 = @install() {
            debug_subtext("B=10");
        },
        b_trigger_11 = @install() {
            debug_subtext("B=11");
        },
        b_trigger_12 = @install() {
            debug_subtext("B=12");
        },
        inn_inn_2_south = nop(),
        inn_inn_2_east = nop(),
        inn_inn_1_east = nop(),
        inn_inn_1_south = nop(),
        gourd_inn_1 = nop(),
        vendor_inn_1_south = nop(),
        vendor_inn_1_east = nop(),

        b_trigger_20 = @install() {
            debug_subtext("B=20");
        },
    }

    fun trigger_enter() {
        // object[0x07] = 0x01; // open gourd_upstairs_1
        // object[0x08] = 0x01; // open gourd_upstairs_2
        // object[0x1a] = 0x01; // change upstairs_layout (0 = bed, 1 = chest closed, wall pass through 2 = chest open, wall closed)
        // object[0x1b] = 0x01; // show wall_upstairs
        // object[0x1c] = 0x01; // show cosmetic_upstairs_1 (crate instead of bed)
        // object[0x1d] = 0x01; // show cosmetic_upstairs_2 (fruit bowl)
        // object[0x1e] = 0x01; // hide cosmetic_upstairs_2 (clock)

        fade_in();
    }
};
map tower_houses__backroom_2chests(IVOR_EBON_HOUSES) {
    enum entrance {
        door = entrance(0x8c, 0x10, SOUTH),
    }

    enum stepon_trigger {
        exit_backroom_3chests = nop(),
        exit_inn_2_left = nop(),
        exit_inn_2_right = nop(),
        exit_stairs_house_3 = nop(),
        exit_door_house_3 = nop(),
        exit_stairs_upstairs = nop(),
        exit_house_1 = nop(),
        exit_door_house_2 = nop(),
        exit_stairs_house_2 = nop(),
        exit_door = @install() {
            debug_subtext("S=9");
        },

        exit_inn_1_left = nop(),
        exit_inn_1_right = nop(),
    }

    enum b_trigger {
        gourd_backroom_3chests_3 = nop(),
        gourd_backroom_3chests_2 = nop(),
        gourd_backroom_3chests_1 = nop(),
        gourd_inn_2 = nop(),
        gourd_house_2 = nop(),
        gourd_house_3_north = nop(),
        gourd_house_3_east = nop(),
        gourd_2 = @install() {
            debug_subtext("B=7");
        },
        gourd_1 = @install() {
            debug_subtext("B=8");
        },
        gourd_upstairs_1 = nop(),

        gourd_upstairs_2 = nop(),
        b_trigger_11 = @install() {
            debug_subtext("B=11");
        },
        b_trigger_12 = @install() {
            debug_subtext("B=12");
        },
        inn_inn_2_south = nop(),
        inn_inn_2_east = nop(),
        inn_inn_1_east = nop(),
        inn_inn_1_south = nop(),
        gourd_inn_1 = nop(),
        vendor_inn_1_south = nop(),
        vendor_inn_1_east = nop(),

        b_trigger_20 = @install() {
            debug_subtext("B=20");
        },
    }

    fun trigger_enter() {
        // object[0x05] = 0x01; // open gourd_backroom_2chests_1
        // object[0x06] = 0x01; // open gourd_backroom_2chests_2

        fade_in();
    }
};
map tower_houses__backroom_3chests(IVOR_EBON_HOUSES) {
    enum entrance {
        door_backroom_3chests = entrance(0x50, 0x0c, SOUTH),
    }

    enum stepon_trigger {
        exit_backroom_3chests = @install() {
            debug_subtext("S=0");
        },
        exit_inn_2_left = nop(),
        exit_inn_2_right = nop(),
        exit_stairs_house_3 = nop(),
        exit_door_house_3 = nop(),
        exit_stairs_upstairs = nop(),
        exit_house_1 = nop(),
        exit_door_house_2 = nop(),
        exit_stairs_house_2 = nop(),
        exit_backroom_2chests = nop(),

        exit_inn_1_left = nop(),
        exit_inn_1_right = nop(),
    }

    enum b_trigger {
        gourd_backroom_3chests_3 = @install() {
            debug_subtext("B=0");
        },
        gourd_backroom_3chests_2 = @install() {
            debug_subtext("B=1");
        },
        gourd_backroom_3chests_1 = @install() {
            debug_subtext("B=2");
        },
        gourd_inn_2 = nop(),
        gourd_house_2 = nop(),
        gourd_house_3_north = nop(),
        gourd_house_3_east = nop(),
        gourd_backroom_2chests_2 = nop(),
        gourd_backroom_2chests_1 = nop(),
        gourd_upstairs_1 = nop(),

        gourd_upstairs_2 = nop(),
        b_trigger_11 = @install() {
            debug_subtext("B=11");
        },
        b_trigger_12 = @install() {
            debug_subtext("B=12");
        },
        inn_inn_2_south = nop(),
        inn_inn_2_east = nop(),
        inn_inn_1_east = nop(),
        inn_inn_1_south = nop(),
        gourd_inn_1 = nop(),
        vendor_inn_1_south = nop(),
        vendor_inn_1_east = nop(),

        b_trigger_20 = @install() {
            debug_subtext("B=20");
        },
    }

    fun trigger_enter() {
        // object[0x01] = 0x01; // open gourd_backroom_3chests_1
        // object[0x02] = 0x01; // open gourd_backroom_3chests_2
        // object[0x03] = 0x01; // open gourd_backroom_3chests_3

        fade_in();
    }
};

map tower_top_half(IVOR_EBON_2) {
    enum entrance {
        north = entrance(0x40, 0x0b, SOUTH),
        south = entrance(0x20, 0x77, NORTH),

        door_1_1_left = entrance(0x2c, 0x63, SOUTH),
        door_1_1_right = entrance(0x44, 0x63, SOUTH),
        door_1_2 = entrance(0x74, 0x63, SOUTH),
        door_1_3 = entrance(0xa2, 0x63, SOUTH),
        door_1_3_back = entrance(0x92, 0x4b, WEST),
        door_2_1 = entrance(0x8e, 0x29, SOUTH),
        door_2_1_back = entrance(0xb7, 0x1f, EAST),
    }

    enum stepon_trigger {
        exit_north = @install() {
            debug_subtext("S=0");
        },
        door_1_1_left = @install() {
            debug_subtext("S=1");
        },
        door_1_1_right = @install() {
            debug_subtext("S=2");
        },
        door_1_2 = @install() {
            debug_subtext("S=3");
        },
        door_1_3 = @install() {
            debug_subtext("S=4");
        },
        door_2_1 = @install() {
            debug_subtext("S=5");
        },
        exit_south = @install() {
            debug_subtext("S=6");
        },
        stepon_7 = @install() {
            debug_subtext("S=7");
        },
        stepon_8 = @install() {
            debug_subtext("S=8");
        },
        door_2_1_back = @install() {
            debug_subtext("S=9");
        },

        door_1_3_back = @install() {
            debug_subtext("S=10");
        },
    }

    fun trigger_enter() {
        fade_in();

        // object[0x00] = 0x7e; // open gate
        // object[0x01] = 0x01; // open door_2_1
        // object[0x02] = 0x01; // open door_1_1_right
        // object[0x03] = 0x01; // open door_1_1_left
        // object[0x04] = 0x01; // replace flower_gate_1 (scrub)
        // object[0x05] = 0x01; // open door_2_1_back AND replace flower_gate_2 (scrub)
        // object[0x06] = 0x01; // replace flower_gate_3 (scrub)
        // object[0x07] = 0x01; // replace flower_gate_4 (scrub)
        // object[0x08] = 0x01; // replace flower_gate_stairs_1 (scrub)
        // object[0x09] = 0x01; // replace flower_gate_stairs_2 (scrub)
        // object[0x0a] = 0x01; // replace flower_gate_stairs_3 (scrub)
        // object[0x0b] = 0x01; // replace flower_gate_stairs_4 (scrub)
        // object[0x0c] = 0x01; // replace flower_gate_stairs_bed_1 (scrub)
        // object[0x0d] = 0x01; // replace flower_gate_stairs_bed_2 (scrub)
        // object[0x0e] = 0x01; // replace flower_gate_stairs_bed_3 (scrub)
        // object[0x0f] = 0x01; // replace door_2_1_flower_1 (scrub)
        // object[0x10] = 0x01; // replace door_2_1_flower_2 (scrub)
        // object[0x11] = 0x01; // replace door_2_1_flower_3 (scrub)
        // object[0x12] = 0x01; // replace door_2_1_flower_4 (scrub)
        // object[0x13] = 0x01; // replace door_2_1_flower_5 (scrub)
        // object[0x14] = 0x01; // replace stairs_lower_1 (scrub)
        // object[0x15] = 0x01; // replace stairs_lower_2 (scrub)
        // object[0x16] = 0x01; // replace stairs_lower_3 (scrub)
        // object[0x17] = 0x01; // replace door_1_3_flower_1 (scrub)
        // object[0x18] = 0x01; // replace door_1_2_flower_2 (scrub)
        // object[0x19] = 0x01; // replace door_1_2_flower_4 (scrub)
        // object[0x1a] = 0x01; // replace door_1_2_flower_3 (scrub)
        // object[0x1b] = 0x01; // replace door_1_2_flower_2 (scrub)
        // object[0x1c] = 0x01; // replace door_1_2_flower_1 (scrub)
        // object[0x1d] = 0x01; // replace door_1_1_flower_2 (scrub)
        // object[0x1e] = 0x01; // replace door_1_1_flower_1 (scrub)
        // object[0x1f] = 0x01; // replace door_1_2_flower_5 (scrub)
        // object[0x20] = 0x02; // change door_1_2 (closed, open, barricaded)
        // object[0x21] = 0x02; // change door_1_3 (closed, open, barricaded)
        // object[0x22] = 0x01; // close door_1_3_back (closed, open, barricaded)
    }
};

map castle_dungeon(IVOR_EBON_PRISON) {
    enum entrance {
        door = entrance(0x2e, 0x11, SOUTH),

        cave_1 = entrance(0x18, 0x1d, SOUTH),
        cave_2 = entrance(0x47, 0x11, SOUTH),
        cave_3 = entrance(0x56, 0x39, SOUTH),
        // ???
        cave_5 = entrance(0x47, 0x3d, SOUTH),
        cave_6 = entrance(0x21, 0x39, SOUTH),
        cave_7 = entrance(0x0c, 0x2f, SOUTH),

        pit_south = entrance(0d42, 0d140, NORTH),
        pit_west = entrance(0d24, 0d115, EAST),
        pit_east = entrance(0d59, 0d115, WEST),
    }

    fun door_triggered() {
        object[0x06] = 0x01; // opens door
    }

    fun open_gate(index) {
        if(index == 0x01) {
            object[0x00] = 0x01; // press switch_1

            object[0x01] = 0x01; // opens gate_1
            sleep(0x10);
            object[0x01] = 0x02; // opens gate_1
            sleep(0x10);
            object[0x01] = 0x03; // opens gate_1
            sleep(0x10);
            object[0x01] = 0x7e; // opens gate_1
        } else if(index == 0x02) {
            object[0x08] = 0x01; // press switch_2

            object[0x07] = 0x01; // opens gate_2
            sleep(0x10);
            object[0x07] = 0x02; // opens gate_2
            sleep(0x10);
            object[0x07] = 0x03; // opens gate_2
            sleep(0x10);
            object[0x07] = 0x7e; // opens gate_2
        } else if(index == 0x03) {
            object[0x0a] = 0x01; // press switch_3

            object[0x09] = 0x01; // opens gate_3
            sleep(0x10);
            object[0x09] = 0x02; // opens gate_3
            sleep(0x10);
            object[0x09] = 0x03; // opens gate_3
            sleep(0x10);
            object[0x09] = 0x7e; // opens gate_3
        } else if(index == 0x04) {
            object[0x0e] = 0x01; // press switch_4

            object[0x0c] = 0x01; // opens gate_4
            sleep(0x10);
            object[0x0c] = 0x02; // opens gate_4
            sleep(0x10);
            object[0x0c] = 0x03; // opens gate_4
            sleep(0x10);
            object[0x0c] = 0x7e; // opens gate_4
        } else if(index == 0x05) {
            object[0x0d] = 0x01; // press switch_5

            object[0x0b] = 0x01; // opens gate_5
            sleep(0x10);
            object[0x0b] = 0x02; // opens gate_5
            sleep(0x10);
            object[0x0b] = 0x03; // opens gate_5
            sleep(0x10);
            object[0x0b] = 0x7e; // opens gate_5
        } else if(index == 0x06) {
            object[0x05] = 0x01; // press switch_6

            object[0x04] = 0x01; // opens gate_6
            sleep(0x10);
            object[0x04] = 0x02; // opens gate_6
            sleep(0x10);
            object[0x04] = 0x03; // opens gate_6
            sleep(0x10);
            object[0x04] = 0x7e; // opens gate_6
        } else if(index == 0x07) {
            object[0x03] = 0x01; // press switch_7

            object[0x02] = 0x01; // opens gate_7
            sleep(0x10);
            object[0x02] = 0x02; // opens gate_7
            sleep(0x10);
            object[0x02] = 0x03; // opens gate_7
            sleep(0x10);
            object[0x02] = 0x7e; // opens gate_7
        }
    }
    
    enum stepon_trigger {
        switch_6 = @install() {
            debug_subtext("S=0");
        },
        switch_5 = @install() {
            debug_subtext("S=1");
        },
        switch_4 = @install() {
            debug_subtext("S=2");
        },
        switch_3 = @install() {
            debug_subtext("S=3");
        },
        switch_2 = @install() {
            debug_subtext("S=4");
        },
        switch_7 = @install() {
            debug_subtext("S=5");
        },
        switch_1 = @install() {
            debug_subtext("S=6");
        },
        exit_door = @install() {
            debug_subtext("S=7");
        },
        stepon_8 = @install() {
            debug_subtext("S=8");
        },
        stepon_9 = @install() {
            debug_subtext("S=9");
        },

        stepon_10 = @install() {
            debug_subtext("S=10");
        },
        stepon_11 = @install() {
            debug_subtext("S=11");
        },
        stepon_12 = @install() {
            debug_subtext("S=12");
        },
        stepon_13 = @install() {
            debug_subtext("S=13");
        },
        stepon_14 = @install() {
            debug_subtext("S=14");
        },
        pipe_3_1 = @install() {
            debug_subtext("S=15");
        },
        pipe_1_1 = @install() {
            debug_subtext("S=16");
        },
        pipe_2_1 = @install() {
            debug_subtext("S=17");
        },
        pipe_2_2 = @install() {
            debug_subtext("S=18");
        },
        pipe_2_3 = @install() {
            debug_subtext("S=19");
        },

        pipe_1_2 = @install() {
            debug_subtext("S=20");
        },
        pipe_1_3 = @install() {
            debug_subtext("S=21");
        },
        pipe_1_4 = @install() {
            debug_subtext("S=22");
        },
        pipe_3_2 = @install() {
            debug_subtext("S=23");
        },
        pipe_3_3 = @install() {
            debug_subtext("S=24");
        },
        pipe_3_4 = @install() {
            debug_subtext("S=25");
        },
        stepon_26 = @install() {
            debug_subtext("S=26");
        },
        stepon_27 = @install() {
            debug_subtext("S=27");
        },
        stepon_28 = @install() {
            debug_subtext("S=28");
        },
        stepon_29 = @install() {
            debug_subtext("S=29");
        },

        stepon_30 = @install() {
            debug_subtext("S=30");
        },
        stepon_31 = @install() {
            debug_subtext("S=31");
        },
    }

    enum b_trigger {
        cell_1_gourd__1_armband_3_1 = @install() {
            debug_subtext("B=0");
            // _loot(0x??, ARMBAND_3_1, 0d01);
        },
    }

    fun trigger_enter() {
        // object[0x06] = 0x01; // opens door
        // object[0x01] = 0x7e; // opens gate_1
        // object[0x07] = 0x7e; // opens gate_2
        // object[0x09] = 0x7e; // opens gate_3
        // object[0x0c] = 0x7e; // opens gate_4
        // object[0x0b] = 0x7e; // opens gate_5
        // object[0x04] = 0x7e; // opens gate_6
        // object[0x02] = 0x7e; // opens gate_7

        // object[0x00] = 0x01; // press switch_1
        // object[0x08] = 0x01; // press switch_2
        // object[0x0a] = 0x01; // press switch_3
        // object[0x0e] = 0x01; // press switch_4
        // object[0x0d] = 0x01; // press switch_5
        // object[0x05] = 0x01; // press switch_6
        // object[0x03] = 0x01; // press switch_7

        // object[0x0f] ???

        // object[0x12] = 0x7e; // drain pipe_1
        // object[0x13] = 0x7e; // drain pipe_2
        // object[0x10] = 0x7e; // drain pipe_3
        // object[0x11] = 0x7e; // drain pipe_4
        // object[0x14] = 0x7e; // drain pipe_5

        fade_in();
    }
};
map castle_dungeon__pit(IVOR_EBON_PRISON) { // variant pit
    enum entrance {
        south = entrance(0d42, 0d140, NORTH),
        west = entrance(0d24, 0d115, EAST),
        east = entrance(0d59, 0d115, WEST),
    }

    enum stepon_trigger {
        switch_6 = nop(),
        switch_5 = nop(),
        switch_4 = nop(),
        switch_3 = nop(),
        switch_2 = nop(),
        switch_7 = nop(),
        switch_1 = nop(),
        exit_door = nop(),
        stepon_8 = nop(),
        stepon_9 = nop(),

        stepon_10 = nop(),
        stepon_11 = nop(),
        stepon_12 = nop(),
        stepon_13 = nop(),
        stepon_14 = nop(),
        pipe_3_1 = nop(),
        pipe_1_1 = nop(),
        pipe_2_1 = nop(),
        pipe_2_2 = nop(),
        pipe_2_3 = nop(),

        pipe_1_2 = nop(),
        pipe_1_3 = nop(),
        pipe_1_4 = nop(),
        pipe_3_2 = nop(),
        pipe_3_3 = nop(),
        pipe_3_4 = nop(),
        stepon_26 = nop(),
        stepon_27 = nop(),
        stepon_28 = nop(),
        stepon_29 = nop(),

        stepon_30 = nop(),
        stepon_31 = nop(),
    }

    enum b_trigger {
        cell_1_gourd__1_armband_3_1 = nop(),
    }

    fun trigger_enter() {
        init_map(0d24, 0d108, 0d60, 0d140);

        fade_in();
    }
};

map sewers_1(EBON_SEWERS) {
    enum entrance {
        door = entrance(0x7a, 0x0b, SOUTH),
        pipe = entrance(0x97, 0x0b, SOUTH),
    }

    enum stepon_trigger {
        exit_door = @install() {
            debug_subtext("S=0");
        },
        exit_pipe = @install() {
            debug_subtext("S=1");
        },
    }

    enum b_trigger {
        wall_x = @install() {
            debug_subtext("B=0");
        },
        wall_x = @install() {
            debug_subtext("B=1");
        },
        wall_x = @install() {
            debug_subtext("B=2");
        },
        wall_x = @install() {
            debug_subtext("B=3");
        },
        wall_x = @install() {
            debug_subtext("B=4");
        },
        wall_x = @install() {
            debug_subtext("B=5");
        },
        wall_x = @install() {
            debug_subtext("B=6");
        },
        wall_x = @install() {
            debug_subtext("B=7");
        },
        gourd_x__5_ash = @install() {
            debug_subtext("B=8");
            _loot_chest(0x0c, ASH, 0d05);
        },
        gourd_x__1_pixie_dust = @install() {
            debug_subtext("B=9");
            _loot_chest(0x0d, PIXIE_DUST, 0d01);
        },

        gourd_x__2_acorns = @install() {
            debug_subtext("B=10");
            _loot_chest(0x0b, ACORNS, 0d02);
        },
        gourd_x__4_water = @install() {
            debug_subtext("B=11");
            _loot_chest(0x0a, WATER, 0d04);
        },
        gourd_x__4_ethanol = @install() {
            debug_subtext("B=12");
            _loot_chest(0x0b, ETHANOL, 0d04);
        },
    }

    fun trigger_enter() {
        fade_in();

        // object[0x00] = 0x01 // hide barrier_7
        // object[0x01] = 0x01 // hide barrier_1
        // object[0x02] = 0x01 // hide barrier_2
        // object[0x03] = 0x01 // hide barrier_8
        // object[0x04] = 0x01 // hide barrier_3
        // object[0x05] = 0x01 // hide barrier_4
        // object[0x06] = 0x01 // hide barrier_6
        // object[0x07] = 0x01 // hide barrier_5
        // object[0x08] = 0x01 // open door
        // object[0x09] = 0x01 // open chest_1_1
        // object[0x0a] = 0x01 // open chest_1_2
        // object[0x0b] = 0x01 // open chest_1_3
        // object[0x0c] = 0x01 // open chest_2_1
        // object[0x0d] = 0x01 // open chest_2_2
    }
};

map sewers_2(IVOR_SEWERS) {
    enum entrance {
        door = entrance(0x66, 0x0d, SOUTH),
        pipe = entrance(0x49, 0x0d, SOUTH),

        east = entrance(0xdf, 0x66, WEST),
    }

    enum stepon_trigger {
        exit_pipe = @install() {
            debug_subtext("S=0");
        },
        exit_door = @install() {
            debug_subtext("S=1");

            vanilla_act3_sewer_door(0x00);

            map_transition(sewers_2, pipe, NONE);
        },
        exit_east_2 = @install() {
            debug_subtext("S=2");
        },
        exit_east_1 = @install() {
            debug_subtext("S=3");
        },
    }

    enum b_trigger {
        gourd_x__2_call_beads = @install() {
            debug_subtext("B=0");
            _loot_chest(0x08, CALL_BEADS, 0d02);
        },
        gourd_x__1_biscuit = @install() {
            debug_subtext("B=1");
            _loot_chest(0x07, BISCUIT, 0d01);
        },
        gourd_x__1_honey = @install() {
            debug_subtext("B=2");
            _loot_chest(0x01, HONEY, 0d01);
        },
        gourd_x__3_mushroom = @install() {
            debug_subtext("B=3");
            _loot_chest(0x02, MUSHROOM, 0d03);
        },
        gourd_x__6_water = @install() {
            debug_subtext("B=4");
            _loot_chest(0x03, WATER, 0d06);
        },
        gourd_x__3_acorns = @install() {
            debug_subtext("B=5");
            _loot_chest(0x04, ACORNS, 0d03);
        },
        gourd_x__4_iron = @install() {
            debug_subtext("B=6");
            _loot_chest(0x05, IRON, 0d04);
        },
        gourd_x__3_oil = @install() {
            debug_subtext("B=7");
            _loot_chest(0x06, OIL, 0d03);
        },
    }

    fun trigger_enter() {
        fade_in();

        // object[0x00] = 0x01; // open door
        // object[0x01] = 0x01; // open chest_4_1
        // object[0x02] = 0x01; // open chest_4_2
        // object[0x03] = 0x01; // open chest_3_1
        // object[0x04] = 0x01; // open chest_3_2
        // object[0x05] = 0x01; // open chest_3_3
        // object[0x06] = 0x01; // open chest_2
        // object[0x07] = 0x01; // open chest_1_1
        // object[0x08] = 0x01; // open chest_1_2
    }
};

map castle_bridges(IVOR_BRIDGE) {
    enum entrance {
        east = entrance(0x8b, 0x28, WEST),
        west = entrance(0x01, 0x29, EAST),

        door_east = entrance(0x45, 0x39, EAST),
        door_west = entrance(0x35, 0x39, WEST),

        balcony_east_1 = entrance(0x4f, 0x0f, EAST),
        balcony_east_2 = entrance(0x4f, 0x19, EAST),
        balcony_east_3 = entrance(0x4f, 0x23, EAST),

        balcony_west_1 = entrance(0x3f, 0x0f, WEST),
        balcony_west_2 = entrance(0x3f, 0x19, WEST),
        balcony_west_3 = entrance(0x3f, 0x23, WEST),
    }

    enum stepon_trigger {
        exit_door_east = @install() {
            debug_subtext("S=0");
        },
        exit_door_west = @install() {
            debug_subtext("S=1");
        },
        exit_east = @install() {
            debug_subtext("S=2");
        },
        balcony_east_3 = @install() {
            debug_subtext("S=3");
        },
        balcony_east_2 = @install() {
            debug_subtext("S=4");
        },
        balcony_east_1 = @install() {
            debug_subtext("S=5");
        },
        exit_west = @install() {
            debug_subtext("S=6");
        },
        balcony_west_1 = @install() {
            debug_subtext("S=7");
        },
        balcony_west_2 = @install() {
            debug_subtext("S=8");
        },
        balcony_west_3 = @install() {
            debug_subtext("S=9");
        },
    }

    fun trigger_enter() {
        fade_in();
    }
};

map balconies(IVOR_ROOMS_2) {
    enum entrance {
        balcony_east_1 = entrance(0x75, 0x1a, WEST),
        balcony_east_2 = entrance(0x75, 0x3c, WEST),
        balcony_east_3 = entrance(0x75, 0x5e, WEST),

        balcony_west_1 = entrance(0x05, 0x5e, EAST),
        balcony_west_1 = entrance(0x05, 0x3c, EAST),
        balcony_west_1 = entrance(0x05, 0x1a, EAST),

        stairs_east = entrance(0x45, 0x39, EAST),
        stairs_west = entrance(0x35, 0x39, WEST),

        vent_east_1 = entrance(0x67, 0x23, NONE),
        vent_east_2 = entrance(0x67, 0x67, NONE),

        vent_west_1 = entrance(0x13, 0x67, NONE),
        vent_west_2 = entrance(0x13, 0x45, NONE),
        vent_west_3 = entrance(0x13, 0x23, NONE),
    }

    enum stepon_trigger {
        door_west_3 = @install() {
            debug_subtext("S=0");
        },
        door_west_2 = @install() {
            debug_subtext("S=1");
        },
        door_west_1 = @install() {
            debug_subtext("S=2");
        },
        door_east_3 = @install() {
            debug_subtext("S=3");
        },
        door_east_2 = @install() {
            debug_subtext("S=4");
        },
        door_east_1 = @install() {
            debug_subtext("S=5");
        },
        vent_west_2 = @install() {
            debug_subtext("S=6");
        },
        vent_west_1 = @install() {
            debug_subtext("S=7");
        },
        vent_west_1 = @install() {
            debug_subtext("S=8");
        },
        vent_west_2 = @install() {
            debug_subtext("S=9");
        },

        vent_west_3 = @install() {
            debug_subtext("S=10");
        },
        stairs_east = @install() {
            debug_subtext("S=11");
        },
        stairs_west = @install() {
            debug_subtext("S=12");
        },
        balcony_east_3 = @install() {
            debug_subtext("S=13");
        },
        balcony_east_2 = @install() {
            debug_subtext("S=14");
        },
        balcony_east_1 = @install() {
            debug_subtext("S=15");
        },
        balcony_west_1 = @install() {
            debug_subtext("S=16");
        },
        balcony_west_2 = @install() {
            debug_subtext("S=17");
        },
        balcony_west_3 = @install() {
            debug_subtext("S=18");
        },
    }

    enum b_trigger {
        sniff__1_water_1 = @install() { // east room 3
            debug_subtext("B=0");
            _loot(0x1f, WATER, 0d01, 0d01);
        },
        sniff__1_water_1 = @install() { // west room 1
            debug_subtext("B=1");
            _loot(0x20, WATER, 0d01, 0d01);
        },
        sniff__1_acorns_1 = @install() { // east room 2 (south)
            debug_subtext("B=2");
            _loot(0x1e, ACORNS, 0d01, 0d01);
        },
        sniff__1_acorns_1 = @install() { // west room 2
            debug_subtext("B=3");
            _loot(0x1d, ACORNS, 0d01, 0d01);
        },
        sniff__1_acorns_1 = @install() { // west room 3
            debug_subtext("B=4");
            _loot(0x1c, ACORNS, 0d01, 0d01);
        },
        sniff__1_feather_1 = @install() { // west halls (south)
            debug_subtext("B=5");
            _loot(0x1b, FEATHER, 0d01, 0d01);
        },
        sniff__1_feather_1 = @install() { // east room 2 (north)
            debug_subtext("B=6");
            _loot(0x1a, FEATHER, 0d01, 0d01);
        },
        sniff__1_feather_1 = @install() { // west halls (north)
            debug_subtext("B=7");
            _loot(0x19, FEATHER, 0d01, 0d01);
        },
        sniff__1_ethanol_1 = @install() { // east room 1 (north)
            debug_subtext("B=8");
            _loot(0x18, ETHANOL, 0d01, 0d01);
        },
        sniff__1_ethanol_1 = @install() { // west room 3 (north)
            debug_subtext("B=9");
            _loot(0x17, ETHANOL, 0d01, 0d01);
        },

        sniff__1_ash_1 = @install() { // east halls (south, window)
            debug_subtext("B=10");
            _loot(0x16, ASH, 0d01, 0d01);
        },
        sniff__1_ash_1 = @install() { // west halls (south)
            debug_subtext("B=11");
            _loot(0x15, ASH, 0d01, 0d01);
        },
        sniff__1_iron_1 = @install() { // east room 1
            debug_subtext("B=12");
            _loot(0x14, IRON, 0d01, 0d01);
        },
        sniff__1_iron_1 = @install() { // west room 3
            debug_subtext("B=13");
            _loot(0x13, IRON, 0d01, 0d01);
        },
        chest_east_3__1_roots = @install() { // east room 3
            debug_subtext("B=14");
            _loot_chest(0x08, ROOTS, 0d01);
        },
        chest_west_1__1_wax = @install() { // west room 1
            debug_subtext("B=15");
            _loot_chest(0x07, WAX, 0d01);
        },
        chest_x__1_water = @install() { // ???
            debug_subtext("B=16");
            _loot_chest(0x20, WATER, 0d01); // same as B=17
        },
        chest_x__1_water = @install() { // ???
            debug_subtext("B=17");
            _loot(0x20, WATER, 0d01, 0d00); // same as B=16
        },
    }

    fun init_room(index) {
        if(index == 0d0) {
            init_map(0x00, 0x00, 0x38, 0x74);
        } else if(index == 0d1) {
            init_map(0x42, 0x00, 0x78, 0x74);
        }
    }

    fun trigger_enter() {
        object[0x00] = 0x7e; // door_west_1
        object[0x01] = 0x7e; // door_west_2
        object[0x02] = 0x7e; // door_west_3
        object[0x03] = 0x7e; // door_east_3
        object[0x04] = 0x7e; // door_east_2
        object[0x05] = 0x7e; // door_east_1

        fade_in();
    }
};
map balconies__west(IVOR_ROOMS_2) { // variant west
    enum entrance {
        balcony_1 = entrance(0x05, 0x5e, EAST),
        balcony_1 = entrance(0x05, 0x3c, EAST),
        balcony_1 = entrance(0x05, 0x1a, EAST),

        stairs = entrance(0x35, 0x39, WEST),

        vent_1 = entrance(0x13, 0x67, NONE),
        vent_2 = entrance(0x13, 0x45, NONE),
        vent_3 = entrance(0x13, 0x23, NONE),
    }

    enum stepon_trigger {
        door_3 = @install() {
            debug_subtext("S=0");
        },
        door_2 = @install() {
            debug_subtext("S=1");
        },
        door_1 = @install() {
            debug_subtext("S=2");
        },
        door_east_3 = nop(),
        door_east_2 = nop(),
        door_east_1 = nop(),
        vent_2 = @install() {
            debug_subtext("S=6");
        },
        vent_1 = @install() {
            debug_subtext("S=7");
        },
        vent_1 = @install() {
            debug_subtext("S=8");
        },
        vent_2 = @install() {
            debug_subtext("S=9");
        },

        vent_3 = @install() {
            debug_subtext("S=10");
        },
        stairs_east = nop(),
        stairs = @install() {
            debug_subtext("S=12");
        },
        balcony_east_3 = nop(),
        balcony_east_2 = nop(),
        balcony_east_1 = nop(),
        balcony_1 = @install() {
            debug_subtext("S=16");
        },
        balcony_2 = @install() {
            debug_subtext("S=17");
        },
        balcony_3 = @install() {
            debug_subtext("S=18");
        },
    }

    enum b_trigger {
        sniff__1_water_1 = nop(), // east room 3
        sniff__1_water_1 = @install() { // west room 1
            debug_subtext("B=1");
            _loot(0x20, WATER, 0d01, 0d01);
        },
        sniff__1_acorns_1 = nop(), // east room 2 (south)
        sniff__1_acorns_1 = @install() { // west room 2
            debug_subtext("B=3");
            _loot(0x1d, ACORNS, 0d01, 0d01);
        },
        sniff__1_acorns_1 = @install() { // west room 3
            debug_subtext("B=4");
            _loot(0x1c, ACORNS, 0d01, 0d01);
        },
        sniff__1_feather_1 = @install() { // west halls (south)
            debug_subtext("B=5");
            _loot(0x1b, FEATHER, 0d01, 0d01);
        },
        sniff__1_feather_1 = nop(), // east room 2 (north)
        sniff__1_feather_1 = @install() { // west halls (north)
            debug_subtext("B=7");
            _loot(0x19, FEATHER, 0d01, 0d01);
        },
        sniff__1_ethanol_1 = nop(), // east room 1 (north)
        sniff__1_ethanol_1 = @install() { // west room 3 (north)
            debug_subtext("B=9");
            _loot(0x17, ETHANOL, 0d01, 0d01);
        },

        sniff__1_ash_1 = nop(),// east halls (south, window)
        sniff__1_ash_1 = @install() { // west halls (south)
            debug_subtext("B=11");
            _loot(0x15, ASH, 0d01, 0d01);
        },
        sniff__1_iron_1 = nop(), // east room 1
        sniff__1_iron_1 = @install() { // west room 3
            debug_subtext("B=13");
            _loot(0x13, IRON, 0d01, 0d01);
        },
        chest_east_3__1_roots = nop(), // east room 3
        chest_west_1__1_wax = @install() { // west room 1
            debug_subtext("B=15");
            _loot_chest(0x07, WAX, 0d01);
        },
        chest_x__1_water = @install() { // ???
            debug_subtext("B=16");
            _loot_chest(0x20, WATER, 0d01); // same as B=17
        },
        chest_x__1_water = @install() { // ???
            debug_subtext("B=17");
            _loot(0x20, WATER, 0d01, 0d00); // same as B=16
        },
    }

    fun init_room(index) {
        if(index == 0d0) {
            init_map(0x00, 0x00, 0x38, 0x74);
        } else if(index == 0d1) {
            init_map(0x42, 0x00, 0x78, 0x74);
        }
    }

    fun trigger_enter() {
        // object[0x00] = 0x7e; // door_west_1
        // object[0x01] = 0x7e; // door_west_2
        // object[0x02] = 0x7e; // door_west_3
        object[0x03] = 0x7e; // door_east_3
        object[0x04] = 0x7e; // door_east_2
        object[0x05] = 0x7e; // door_east_1

        init_room(0d0);
        fade_in();
    }
};
map balconies__east(IVOR_ROOMS_2) { // variant east
    enum entrance {
        balcony_1 = entrance(0x75, 0x1a, WEST),
        balcony_2 = entrance(0x75, 0x3c, WEST),
        balcony_3 = entrance(0x75, 0x5e, WEST),

        stairs = entrance(0x45, 0x39, EAST),

        vent_1 = entrance(0x67, 0x23, NONE),
        vent_2 = entrance(0x67, 0x67, NONE),
    }

    enum stepon_trigger {
        door_west_3 = nop(),
        door_west_2 = nop(),
        door_west_1 = nop(),
        door_3 = @install() {
            debug_subtext("S=3");
        },
        door_2 = @install() {
            debug_subtext("S=4");
        },
        door_1 = @install() {
            debug_subtext("S=5");
        },
        vent_west_2 = nop(),
        vent_west_1 = nop(),
        vent_west_1 = nop(),
        vent_west_2 = nop(),

        vent_west_3 = nop(),
        stairs = @install() {
            debug_subtext("S=11");
        },
        stairs_west = nop(),
        balcony_3 = @install() {
            debug_subtext("S=13");
        },
        balcony_2 = @install() {
            debug_subtext("S=14");
        },
        balcony_1 = @install() {
            debug_subtext("S=15");
        },
        balcony_west_1 = nop(),
        balcony_west_2 = nop(),
        balcony_west_3 = nop(),
    }

    enum b_trigger {
        sniff__1_water_1 = @install() { // east room 3
            debug_subtext("B=0");
            _loot(0x1f, WATER, 0d01, 0d01);
        },
        sniff__1_water_1 = nop(), // west room 1
        sniff__1_acorns_1 = @install() { // east room 2 (south)
            debug_subtext("B=2");
            _loot(0x1e, ACORNS, 0d01, 0d01);
        },
        sniff__1_acorns_1 = nop(), // west room 2
        sniff__1_acorns_1 = nop(), // west room 3
        sniff__1_feather_1 = nop(), // west halls (south)
        sniff__1_feather_1 = @install() { // east room 2 (north)
            debug_subtext("B=6");
            _loot(0x1a, FEATHER, 0d01, 0d01);
        },
        sniff__1_feather_1 = nop(), // west halls (north)
        sniff__1_ethanol_1 = @install() { // east room 1 (north)
            debug_subtext("B=8");
            _loot(0x18, ETHANOL, 0d01, 0d01);
        },
        sniff__1_ethanol_1 = nop(), // west room 3 (north)

        sniff__1_ash_1 = @install() { // east halls (south, window)
            debug_subtext("B=10");
            _loot(0x16, ASH, 0d01, 0d01);
        },
        sniff__1_ash_1 = nop(), // west halls (south)
        sniff__1_iron_1 = @install() { // east room 1
            debug_subtext("B=12");
            _loot(0x14, IRON, 0d01, 0d01);
        },
        sniff__1_iron_1 = nop(), // west room 3
        chest_east_3__1_roots = @install() { // east room 3
            debug_subtext("B=14");
            _loot_chest(0x08, ROOTS, 0d01);
        },
        chest_west_1__1_wax = nop(), // west room 1
        chest_x__1_water = @install() { // ???
            debug_subtext("B=16");
            _loot_chest(0x20, WATER, 0d01); // same as B=17
        },
        chest_x__1_water = @install() { // ???
            debug_subtext("B=17");
            _loot(0x20, WATER, 0d01, 0d00); // same as B=16
        },
    }

    fun init_room(index) {
        if(index == 0d0) {
            init_map(0x00, 0x00, 0x38, 0x74);
        } else if(index == 0d1) {
            init_map(0x42, 0x00, 0x78, 0x74);
        }
    }

    fun trigger_enter() {
        // object[0x00] = 0x7e; // door_west_1
        // object[0x01] = 0x7e; // door_west_2
        // object[0x02] = 0x7e; // door_west_3
        object[0x03] = 0x7e; // door_east_3
        object[0x04] = 0x7e; // door_east_2
        object[0x05] = 0x7e; // door_east_1

        init_room(0d1);
        fade_in();
    }
};

map dark_forest_entrance(DARK_FOREST_ENTRANCE) {
    enum entrance {
        north = entrance(0x0b, 0x0b, SOUTH),
        south = entrance(0x0e, 0x25, NORTH),

        wings = entrance(0x09, 0x15, NONE),
    }

    enum stepon_trigger {
        exit_south = @install() {
            debug_subtext("S=0");
        },
        exit_north = @install() {
            debug_subtext("S=1");
        },
    }

    fun trigger_enter() {
        fade_in();
    }
};

map dark_forest(DARK_FOREST) {
    enum entrance {
        room_1_east = entrance(0x35, 0x16, WEST),
        room_1_north = entrance(0x18, 0x1f, NORTH),
        room_1_west = entrance(0x00, 0x15, EAST),

        room_2_east = entrance(0x6f, 0x17, WEST),
        room_2_south_1 = entrance(0x65, 0x1f, NORTH),
        room_2_south_2 = entrance(0x46, 0x1f, NORTH),
        room_2_west = entrance(0x38, 0x18, EAST),

        room_3_north = entrance(0x5f, 0x25, SOUTH),
        room_3_west = entrance(0x4b, 0x4c, EAST),
        room_3_south = entrance(0x5a, 0x55, NORTH),

        room_4_north = entrance(0x39, 0x24, SOUTH),
        room_4_east = entrance(0x48, 0x4b, WEST),
        room_4_west = entrance(0x26, 0x4e, EAST),

        room_5_north = entrance(0x11, 0x25, SOUTH),
        room_5_east = entrance(0x22, 0x38, WEST),
        room_5_south = entrance(0x11, 0x55, NORTH),
        room_5_west = entrance(0x00, 0x38, EAST),
        room_5_center = entrance(0x12, 0x38, NONE),
    }

    enum stepon_trigger {
        exit_room_3_south = @install() {
            debug_subtext("S=0");
        },
        exit_room_4_west = @install() {
            debug_subtext("S=1");
        },
        exit_room_1_west = @install() {
            debug_subtext("S=2");
        },
        exit_room_1_east = @install() {
            debug_subtext("S=3");
        },
        exit_room_1_south = @install() {
            debug_subtext("S=4");
        },
        exit_room_2_south_2 = @install() {
            debug_subtext("S=5");
        },
        exit_room_2_east = @install() {
            debug_subtext("S=6");
        },
        stepon_7 = @install() {
            debug_subtext("S=7");
        },
        exit_room_5_west = @install() {
            debug_subtext("S=8");
        },
        exit_room_5_east = @install() {
            debug_subtext("S=9");
        },

        exit_room_5_north = @install() {
            debug_subtext("S=10");
        },
        exit_room_5_south = @install() {
            debug_subtext("S=11");
        },
        exit_room_4_north = @install() {
            debug_subtext("S=12");
        },
        exit_room_3_north = @install() {
            debug_subtext("S=13");
        },
        exit_room_4_east = @install() {
            debug_subtext("S=14");
        },
        exit_room_3_west = @install() {
            debug_subtext("S=15");
        },
        exit_room_2_south_1 = @install() {
            debug_subtext("S=16");
        },
    }

    enum b_trigger {
        b_trigger_0 = @install() {
            debug_subtext("B=0");
        },
        b_trigger_1 = @install() {
            debug_subtext("B=1");
        },
        room_2_sign = @install() {
            debug_subtext("B=2");
        },
        room_1_sign = @install() {
            debug_subtext("B=3");
        },
        room_3_sniff = @install() {
            debug_subtext("B=4");
        },
        room_5_sniff = @install() {
            debug_subtext("B=5");
        },
        b_trigger_6 = @install() {
            debug_subtext("B=6");
        },
        room_1_sniff = @install() {
            debug_subtext("B=7");
        },
        room_2_sniff = @install() {
            debug_subtext("B=8");
        },
    }

    fun prepare_room(index) {
        if(index == 0x01) {
            init_map(0x00, 0x00, 0x34, 0x1e); // room_1

            // MEMORY.FOREGROUND_OFFSET_X = 0x0000;
            // MEMORY.FOREGROUND_OFFSET_Y = 0x02c0;

            // MEMORY.FOREGROUND_OFFSET_X = 0x0160;
            // MEMORY.FOREGROUND_OFFSET_Y = 0x02c0;
            
            // MEMORY.FOREGROUND_OFFSET_X = 0x0000;
            // MEMORY.FOREGROUND_OFFSET_Y = 0x03e0;
            
            // MEMORY.FOREGROUND_OFFSET_X = 0x0190;
            // MEMORY.FOREGROUND_OFFSET_Y = 0x03e0;
            
            // MEMORY.FOREGROUND_OFFSET_X = 0x0030;
            // MEMORY.FOREGROUND_OFFSET_Y = 0x03e0;
            
            MEMORY.FOREGROUND_OFFSET_X = 0x00c0;
            MEMORY.FOREGROUND_OFFSET_Y = 0x02c0;
        } else if(index == 0x02) {
            init_map(0x38, 0x00, 0x6e, 0x1e); // room 2

            // MEMORY.FOREGROUND_OFFSET_X = 0x0390;
            // MEMORY.FOREGROUND_OFFSET_Y = 0x0180;

            MEMORY.FOREGROUND_OFFSET_X = 0x0280; // custom
            MEMORY.FOREGROUND_OFFSET_Y = 0x02C0;
        } else if(index == 0x03) {
            init_map(0x4c, 0x24, 0x6e, 0x54); // room_3

            // MEMORY.FOREGROUND_OFFSET_X = 0x0280; // custom + buggy?
            // MEMORY.FOREGROUND_OFFSET_Y = 0x02C0;

            MEMORY.FOREGROUND_OFFSET_X = 0x00a0; // custom
            MEMORY.FOREGROUND_OFFSET_Y = 0x0000;
        } else if(index == 0x04) {
            init_map(0x26, 0x24, 0x48, 0x54); // room_4

            MEMORY.FOREGROUND_OFFSET_X = 0x0218; // custom
            MEMORY.FOREGROUND_OFFSET_Y = 0x0000;
        } else if(index == 0x05) {
            init_map(0x00, 0x24, 0x22, 0x54); // room_5

            // MEMORY.FOREGROUND_OFFSET_X = 0x0390;
            // MEMORY.FOREGROUND_OFFSET_Y = 0x0000;
            
            MEMORY.FOREGROUND_OFFSET_X = 0x0390;
            MEMORY.FOREGROUND_OFFSET_Y = 0x0090;

            // MEMORY.FOREGROUND_OFFSET_X = 0x0390;
            // MEMORY.FOREGROUND_OFFSET_Y = 0x0130;
        }
    }

    fun trigger_enter() {
        // object[0x00] = 0x01; // opens room_1_south
        // object[0x01] = 0x01; // closes room_1_east
        // object[0x12] = 0x01; // hides room_1_sign
        // object[0x09] = 0x01; // shows room_1_decoration (stone)

        // object[0x02] = 0x01; // hides room_2_sign
        // object[0x02] = 0x02; // closes room_2_west
        // object[0x02] = 0x03; // opens room_2_west, closes room_2_south
        // object[0x03] = 0x01; // opens room_2_south_1
        // object[0x0a] = 0x01; // shows room_2_decoration (stone -> tree)
        
        // object[0x08] = 0x01; // opens room_3_south, closes room_3_west
        // object[0x08] = 0x02; // closes room_3_west
        // object[0x0f] = 0x01; // shows room_3_decoration_1 (sign)
        // object[0x10] = 0x01; // shows room_3_decoration_2 (stone)
        // object[0x11] = 0x01; // shows room_3_decoration_3 (tree)
        // object[0x13] = 0x01; // closes room_3_north

        // object[0x06] = 0x01; // closes room_4_north
        // object[0x07] = 0x01; // opens room_4_west
        // object[0x0e] = 0x01; // shows room_4_decoration (stone)

        // object[0x04] = 0x01; // opens room_5_west
        // object[0x05] = 0x01; // opens room_5_east
        // object[0x0b] = 0x01; // shows room_5_decoration_1 (sign)
        // object[0x0c] = 0x01; // shows room_5_decoration_2 (tree)
        // object[0x0d] = 0x01; // shows room_5_decoration_3 (stone)

        fade_in();
    }
};
map dark_forest_room_1(DARK_FOREST) { // variation: "--", ",-", "<-"
    enum entrance {
        east = entrance(0x35, 0x16, WEST),
        south = entrance(0x18, 0x1f, NORTH),
        west = entrance(0x00, 0x15, EAST),
    }

    enum stepon_trigger {
        exit_room_3_south = nop(),
        exit_room_4_west = nop(),
        exit_west = @install() {
            debug_subtext("S=2");
        },
        exit_east = @install() {
            debug_subtext("S=3");
        },
        exit_south = @install() {
            debug_subtext("S=4");
        },
        exit_room_2_south_2 = nop(),
        exit_room_2_east = nop(),
        stepon_7 = @install() {
            debug_subtext("S=7");
        },
        exit_room_5_west = nop(),
        exit_room_5_east = nop(),

        exit_room_5_north = nop(),
        exit_room_5_south = nop(),
        exit_room_4_north = nop(),
        exit_room_3_north = nop(),
        exit_room_4_east = nop(),
        exit_room_3_west = nop(),
        exit_room_2_south_1 = nop(),
    }

    enum b_trigger {
        b_trigger_0 = @install() {
            debug_subtext("B=0");
        },
        b_trigger_1 = @install() {
            debug_subtext("B=1");
        },
        room_2_sign = nop(),
        sign = @install() {
            debug_subtext("B=3");
        },
        room_3_sniff = nop(),
        room_5_sniff = nop(),
        b_trigger_6 = @install() {
            debug_subtext("B=6");
        },
        sniff = @install() {
            debug_subtext("B=7");
        },
        room_2_sniff = nop(),
    }

    fun prepare_room(index) {
        init_map(0x00, 0x00, 0x34, 0x1e); // room_1

        // MEMORY.FOREGROUND_OFFSET_X = 0x0000;
        // MEMORY.FOREGROUND_OFFSET_Y = 0x02c0;

        // MEMORY.FOREGROUND_OFFSET_X = 0x0160;
        // MEMORY.FOREGROUND_OFFSET_Y = 0x02c0;
        
        // MEMORY.FOREGROUND_OFFSET_X = 0x0000;
        // MEMORY.FOREGROUND_OFFSET_Y = 0x03e0;
        
        // MEMORY.FOREGROUND_OFFSET_X = 0x0190;
        // MEMORY.FOREGROUND_OFFSET_Y = 0x03e0;
        
        // MEMORY.FOREGROUND_OFFSET_X = 0x0030;
        // MEMORY.FOREGROUND_OFFSET_Y = 0x03e0;
        
        MEMORY.FOREGROUND_OFFSET_X = 0x00c0;
        MEMORY.FOREGROUND_OFFSET_Y = 0x02c0;
    }

    fun trigger_enter() {
        prepare_room();

        // object[0x00] = 0x01; // opens room_1_south
        // object[0x01] = 0x01; // closes room_1_east
        // object[0x12] = 0x01; // hides room_1_sign
        // object[0x09] = 0x01; // shows room_1_decoration (stone)

        fade_in();
    }
};
map dark_forest_room_2(DARK_FOREST) { // variation: ",-", ",-,"
    enum entrance {
        east = entrance(0x6f, 0x17, WEST),
        south_1 = entrance(0x65, 0x1f, NORTH),
        south_2 = entrance(0x46, 0x1f, NORTH),
        west = entrance(0x38, 0x18, EAST),
    }

    enum stepon_trigger {
        exit_room_3_south = nop(),
        exit_room_4_west = nop(),
        exit_room_1_west = nop(),
        exit_room_1_east = nop(),
        exit_room_1_south = nop(),
        south_2 = @install() {
            debug_subtext("S=5");
        },
        east = @install() {
            debug_subtext("S=6");
        },
        stepon_7 = @install() {
            debug_subtext("S=7");
        },
        exit_room_5_west = nop(),
        exit_room_5_east = nop(),

        exit_room_5_north = nop(),
        exit_room_5_south = nop(),
        exit_room_4_north = nop(),
        exit_room_3_north = nop(),
        exit_room_4_east = nop(),
        exit_room_3_west = nop(),
        south_1 = @install() {
            debug_subtext("S=16");
        },
    }

    enum b_trigger {
        b_trigger_0 = @install() {
            debug_subtext("B=0");
        },
        b_trigger_1 = @install() {
            debug_subtext("B=1");
        },
        room_2_sign = @install() {
            debug_subtext("B=2");
        },
        room_1_sign = nop(),
        room_3_sniff = nop(),
        room_5_sniff = nop(),
        b_trigger_6 = @install() {
            debug_subtext("B=6");
        },
        room_1_sniff = nop(),
        sniff = @install() {
            debug_subtext("B=8");
        },
    }

    fun prepare_room() {
        init_map(0x38, 0x00, 0x6e, 0x1e); // room 2

        // MEMORY.FOREGROUND_OFFSET_X = 0x0390;
        // MEMORY.FOREGROUND_OFFSET_Y = 0x0180;

        MEMORY.FOREGROUND_OFFSET_X = 0x0280; // custom
        MEMORY.FOREGROUND_OFFSET_Y = 0x02C0;
    }

    fun trigger_enter() {
        prepare_room();

        // object[0x02] = 0x01; // hides room_2_sign
        // object[0x02] = 0x02; // closes room_2_west
        // object[0x02] = 0x03; // opens room_2_west, closes room_2_south
        // object[0x03] = 0x01; // opens room_2_south_1
        // object[0x0a] = 0x01; // shows room_2_decoration (stone -> tree)

        fade_in();
    }
};
map dark_forest_room_3(DARK_FOREST) { // variation: "^", "_|"
    enum entrance {
        north = entrance(0x5f, 0x25, SOUTH),
        west = entrance(0x4b, 0x4c, EAST),
        south = entrance(0x5a, 0x55, NORTH),
    }

    enum stepon_trigger {
        exit_south = @install() {
            debug_subtext("S=0");
        },
        exit_room_4_west = nop(),
        exit_room_1_west = nop(),
        exit_room_1_east = nop(),
        exit_room_1_south = nop(),
        exit_room_2_south_2 = nop(),
        exit_room_2_east = nop(),
        stepon_7 = @install() {
            debug_subtext("S=7");
        },
        exit_room_5_west = nop(),
        exit_room_5_east = nop(),

        exit_room_5_north = nop(),
        exit_room_5_south = nop(),
        exit_room_4_north = nop(),
        exit_north = @install() {
            debug_subtext("S=13");
        },
        exit_room_4_east = nop(),
        exit_room_3_west = @install() {
            debug_subtext("S=15");
        },
        exit_room_2_south_1 = nop(),
    }

    enum b_trigger {
        b_trigger_0 = @install() {
            debug_subtext("B=0");
        },
        b_trigger_1 = @install() {
            debug_subtext("B=1");
        },
        room_2_sign = nop(),
        room_1_sign = nop(),
        sniff = @install() {
            debug_subtext("B=4");
        },
        room_5_sniff = nop(),
        b_trigger_6 = @install() {
            debug_subtext("B=6");
        },
        room_1_sniff = nop(),
        room_2_sniff = nop(),
    }

    fun prepare_room() {
        init_map(0x4c, 0x24, 0x6e, 0x54); // room_3

        // MEMORY.FOREGROUND_OFFSET_X = 0x0280; // custom + buggy?
        // MEMORY.FOREGROUND_OFFSET_Y = 0x02C0;

        MEMORY.FOREGROUND_OFFSET_X = 0x00a0; // custom
        MEMORY.FOREGROUND_OFFSET_Y = 0x0000;
    }

    fun trigger_enter() {
        prepare_room(0x03);

        // object[0x08] = 0x01; // opens room_3_south, closes room_3_west
        // object[0x08] = 0x02; // closes room_3_west
        // object[0x0f] = 0x01; // shows room_3_decoration_1 (sign)
        // object[0x10] = 0x01; // shows room_3_decoration_2 (stone)
        // object[0x11] = 0x01; // shows room_3_decoration_3 (tree)
        // object[0x13] = 0x01; // closes room_3_north

        fade_in();
    }
};
map dark_forest_room_4(DARK_FOREST) { // variation: "L"
    enum entrance {
        north = entrance(0x39, 0x24, SOUTH),
        east = entrance(0x48, 0x4b, WEST),
        west = entrance(0x26, 0x4e, EAST),
    }

    enum stepon_trigger {
        exit_room_3_south = nop(),
        exit_west = @install() {
            debug_subtext("S=1");
        },
        exit_room_1_west = nop(),
        exit_room_1_east = nop(),
        exit_room_1_south = nop(),
        exit_room_2_south_2 = nop(),
        exit_room_2_east = nop(),
        stepon_7 = @install() {
            debug_subtext("S=7");
        },
        exit_room_5_west = nop(),
        exit_room_5_east = nop(),

        exit_room_5_north = nop(),
        exit_room_5_south = nop(),
        exit_north = @install() {
            debug_subtext("S=12");
        },
        exit_room_3_north = nop(),
        exit_east = @install() {
            debug_subtext("S=14");
        },
        exit_room_3_west = nop(),
        exit_room_2_south_1 = nop(),
    }

    enum b_trigger {
        b_trigger_0 = @install() {
            debug_subtext("B=0");
        },
        b_trigger_1 = @install() {
            debug_subtext("B=1");
        },
        room_2_sign = nop(),
        room_1_sign = nop(),
        room_3_sniff = nop(),
        room_5_sniff = nop(),
        b_trigger_6 = @install() {
            debug_subtext("B=6");
        },
        room_1_sniff = nop(),
        room_2_sniff = nop(),
    }

    fun prepare_room() {
        init_map(0x26, 0x24, 0x48, 0x54); // room_4

        MEMORY.FOREGROUND_OFFSET_X = 0x0218; // custom
        MEMORY.FOREGROUND_OFFSET_Y = 0x0000;
    }

    fun trigger_enter() {
        prepare_room();

        // object[0x06] = 0x01; // closes room_4_north
        // object[0x07] = 0x01; // opens room_4_west
        // object[0x0e] = 0x01; // shows room_4_decoration (stone)

        fade_in();
    }
};
map dark_forest_room_5(DARK_FOREST) { // variation
    enum entrance {
        north = entrance(0x11, 0x25, SOUTH),
        east = entrance(0x22, 0x38, WEST),
        south = entrance(0x11, 0x55, NORTH),
        west = entrance(0x00, 0x38, EAST),

        center = entrance(0x12, 0x38, NONE),
    }

    enum stepon_trigger {
        exit_room_3_south = nop(),
        exit_room_4_west = nop(),
        exit_room_1_west = nop(),
        exit_room_1_east = nop(),
        exit_room_1_south = nop(),
        exit_room_2_south_2 = nop(),
        exit_room_2_east = nop(),
        stepon_7 = @install() {
            debug_subtext("S=7");
        },
        exit_west = @install() {
            debug_subtext("S=8");
        },
        exit_east = @install() {
            debug_subtext("S=9");
        },

        exit_north = @install() {
            debug_subtext("S=10");
        },
        exit_south = @install() {
            debug_subtext("S=11");
        },
        exit_room_4_north = nop(),
        exit_room_3_north = nop(),
        exit_room_4_east = nop(),
        exit_room_3_west = nop(),
        exit_room_2_south_1 = nop(),
    }

    enum b_trigger {
        b_trigger_0 = @install() {
            debug_subtext("B=0");
        },
        b_trigger_1 = @install() {
            debug_subtext("B=1");
        },
        room_2_sign = nop(),
        room_1_sign = nop(),
        room_3_sniff = nop(),
        sniff = @install() {
            debug_subtext("B=5");
        },
        b_trigger_6 = @install() {
            debug_subtext("B=6");
        },
        room_1_sniff = nop(),
        room_2_sniff = nop(),
    }

    fun prepare_room(index) {
        init_map(0x00, 0x24, 0x22, 0x54); // room_5

        // MEMORY.FOREGROUND_OFFSET_X = 0x0390;
        // MEMORY.FOREGROUND_OFFSET_Y = 0x0000;
        
        MEMORY.FOREGROUND_OFFSET_X = 0x0390;
        MEMORY.FOREGROUND_OFFSET_Y = 0x0090;

        // MEMORY.FOREGROUND_OFFSET_X = 0x0390;
        // MEMORY.FOREGROUND_OFFSET_Y = 0x0130;
    }

    fun trigger_enter() {
        prepare_room();

        // object[0x04] = 0x01; // opens room_5_west
        // object[0x05] = 0x01; // opens room_5_east
        // object[0x0b] = 0x01; // shows room_5_decoration_1 (sign)
        // object[0x0c] = 0x01; // shows room_5_decoration_2 (tree)
        // object[0x0d] = 0x01; // shows room_5_decoration_3 (stone)
        
        fade_in();
    }
};

map between_act3(CROSSING_ACT3) {
    enum entrance {
        north = entrance(0x17, 0x01, SOUTH),
        east = entrance(0x2b, 0x11, WEST),
        west = entrance(0x06, 0x18, EAST),
    }

    enum stepon_trigger {
        exit_west = @install() {
            debug_subtext("S=0");
        },
        stepon_1 = @install() {
            debug_subtext("S=1");
        },
        exit_north = @install() {
            debug_subtext("S=2");
        },
        exit_east = @install() {
            debug_subtext("S=3");
        },
    }

    enum b_trigger {
        barrier = @install() {
            debug_subtext("B=0");
        },
    }

    fun trigger_enter() {
        fade_in();
    }
};

map sewers_landing_spot(IVOR_SEWERS_EXTERIOR) {
    enum entrance {
        west = entrance(0x05, 0x0b, EAST),
        cinematic_west = entrance(0x2d, 0x7, NONE),
    }

    enum stepon_trigger {
        pipe = @install() {
            debug_subtext("S=0");
        },
        exit_west = @install() {
            debug_subtext("S=1");
        },
    }

    fun trigger_enter() {
        fade_in();
    }
};

map stairs(CHESSBOARD_STAIRS) {
    enum entrance {
        stairs_east_top = entrance(0x43, 0x03, SOUTH),
        stairs_west_top = entrance(0x15, 0x05, SOUTH),
        stairs_west_bottom = entrance(0x5f, 0xa1, NORTH),
    }

    enum stepon_trigger {
        cutscene_energy_core = @install() {
            debug_subtext("S=0");
        },
        exit_stairs_west_bottom = @install() {
            debug_subtext("S=1");
        },
        exit_stairs_west_top = @install() {
            debug_subtext("S=2");
        },
        exit_stairs_east_top = @install() {
            debug_subtext("S=3");
        },
    }

    enum b_trigger {
        pickup_energy_core = @install() {
            debug_subtext("B=0");
        },
    }

    fun trigger_enter() {
        // object[0x00] = 0x7e; // remove energy_core_hitbox

        fade_in();
    }
};

map footknight(FOOTKNIGHT) {
    enum entrance {
        east = entrance(0x93, 0x42, WEST),
        west = entrance(0x01, 0x42, EAST),
        stairs_east = entrance(0x53, 0x4c, WEST),
        stairs_west = entrance(0x40, 0x40, EAST) // 0x4c, 0x40
    }

    enum stepon_trigger {
        stairs_east = @install() {
            debug_subtext("S=0");
            // map_transition(footknight, stairs_west, EAST);
        },
        spawn_boss = @install() {
            debug_subtext("S=1");
        },
        exit_west = @install() {
            debug_subtext("S=2");
            // map_transition(footknight, east, WEST);
        },
        exit_east = @install() {
            debug_subtext("S=3");
            // map_transition(footknight, west, EAST);
        },
        stairs_west = @install() {
            debug_subtext("S=4");
            // map_transition(footknight, stairs_east, WEST);
        }
    }

    enum b_trigger {
        sniff__1_water_3 = @install() {
            debug_subtext("B=0");
            _loot(0x18, WATER, 0d01, 0d03);
        },
        sniff__1_water_1 = @install() {
            debug_subtext("B=1");
            _loot(0x17, WATER, 0d01, 0d01);
        },
        sniff__1_ash_2 = @install() {
            debug_subtext("B=2");
            _loot(0x16, ASH, 0d01, 0d02);
        },
        sniff__1_ash_3 = @install() {
            debug_subtext("B=3");
            _loot(0x15, ASH, 0d01, 0d03);
        },
        sniff__1_roots_2 = @install() {
            debug_subtext("B=4");
            _loot(0x14, ROOTS, 0d01, 0d02);
        },
        sniff__1_roots_4 = @install() {
            debug_subtext("B=5");
            _loot(0x13, ROOTS, 0d01, 0d04);
        },
        sniff__1_roots_3 = @install() {
            debug_subtext("B=6");
            _loot(0x12, ROOTS, 0d01, 0d03);
        },
        sniff__1_roots_4 = @install() {
            debug_subtext("B=7");
            _loot(0x11, ROOTS, 0d01, 0d04);
        },
        sniff__1_brimstone_3 = @install() {
            debug_subtext("B=8");
            _loot(0x10, BRIMSTONE, 0d01, 0d03);
        },
        sniff__1_brimstone_1 = @install() {
            debug_subtext("B=9");
            _loot(0x0f, BRIMSTONE, 0d01, 0d01);
        },

        sniff__1_brimstone_1 = @install() {
            debug_subtext("B=10");
            _loot(0x0e, BRIMSTONE, 0d01, 0d01);
        },
        sniff__1_iron_3 = @install() {
            debug_subtext("B=11");
            _loot(0x0d, IRON, 0d01, 0d03);
        },
        sniff__1_iron = @install() {
            debug_subtext("B=12");
            _loot(0x0c, IRON, 0d01, 0d00);
        },
        sniff__1_feather_2 = @install() {
            debug_subtext("B=13");
            _loot(0x0b, FEATHER, 0d01, 0d02);
        },
        sniff__1_acorns_3 = @install() {
            debug_subtext("B=14");
            _loot(0x0a, ACORNS, 0d01, 0d03);
        },
        sniff__1_acorns_2 = @install() {
            debug_subtext("B=15");
            _loot(0x09, ACORNS, 0d01, 0d02);
        },
        sniff__1_acorns_2 = @install() {
            debug_subtext("B=16");
            _loot(0x08, ACORNS, 0d01, 0d02);
        },
        sniff__1_mushroom_3 = @install() {
            debug_subtext("B=17");
            _loot(0x07, MUSHROOM, 0d01, 0d03);
        },
        sniff__1_mushroom_2 = @install() {
            debug_subtext("B=18");
            _loot(0x06, MUSHROOM, 0d01, 0d02);
        }
    }

    fun trigger_enter() {
        // object[0x00] = 0x7e; // close stairs_west
        // object[0x01] = 0x7e; // close stairs_east
        // object[0x02] = 0x01; // close wall_2
        // object[0x03] = 0x01; // close wall_1
        // object[0x04] = 0x01; // remove bridge_east
        // object[0x05] = 0x01; // remove bridge_west

        fade_in();
    }
};

map bad_boys(BAD_BOYS) {
    enum entrance {
        east = entrance(0x63, 0x1d, WEST),
        west = entrance(0x01, 0x21, EAST)
    }

    enum stepon_trigger {
        exit_east = @install() {
            debug_subtext("S=0");
        },
        exit_west = @install() {
            debug_subtext("S=1");
        }
    }

    fun open_east_exit(open) {
        if(open) {
           object[0x00] = 0x00; 
        } else {
            object[0x00] = 0x7e;
        }
    }
    fun open_bridge(open) {
        if(open) {
           object[0x07] = 0x07e; 
        } else {
            object[0x07] = 0x00;
        }
    }

    fun trigger_enter() {
        // object[0x00] = 0x02; // close exit_west
        // object[0x01] = 0x01; // remove stone_1_1
        // object[0x02] = 0x01; // remove stone_1_2
        // object[0x03] = 0x01; // remove stone_1_3
        // object[0x04] = 0x01; // remove stone_2_1
        // object[0x05] = 0x01; // remove stone_2_2
        // object[0x06] = 0x01; // remove stone_2_3
        // object[0x07] = 0x01; // remove base

        fade_in();
    }
};

map timberdrake(TIMBERDRAKE) {
    enum entrance {
        east = entrance(0x2b, 0x15, WEST),
        south = entrance(0x1b, 0x29, NORTH)
    }

    enum stepon_trigger {
        exit_east = @install() {
            debug_subtext("S=0");
        },
        exit_south = @install() {
            debug_subtext("S=1");
        }
    }

    fun trigger_enter() {
        fade_in();

        // object[0x00] = 0x01; // close south
        // object[0x01] = 0x01; // open east
    }
};

map gomis_swamp(SWAMP_BRIDGE) {
    enum entrance {
        north = entrance(0x0b, 0x01, SOUTH),
        south = entrance(0x1b, 0x53, NORTH)
    }

    enum stepon_trigger {
        exit_north = @install() {
            debug_subtext("S=0");
        },
        exit_south = @install() {
            debug_subtext("S=1");
        }
    }

    fun trigger_enter() {
        fade_in();
    }
};

map ivor_hall(IVOR_HALL) {
    enum entrance {
        north_1 = entrance(0x12, 0x11, SOUTH),
        north_2 = entrance(0x3e, 0x45, SOUTH),
        east = entrance(0x4b, 0x54, WEST),
        south = entrance(0x2d, 0x75, NORTH),
    }

    enum stepon_trigger {
        stepon_0 = @install() {
            debug_subtext("S=0");

            vanilla_a3_stairs_helper(0x05, 0x0e, 0x1e, False);
        },
        stairs_helper_1 = @install() {
            debug_subtext("S=1");

            vanilla_a3_stairs_helper(0x06, 0x0e, 0x2e, False);
        },
        stairs_helper_2 = @install() {
            debug_subtext("S=2");

            vanilla_a3_stairs_helper(0x06, 0x0e, 0x34, True);
        },
        stepon_3 = @install() {
            debug_subtext("S=3");

            vanilla_a3_stairs_helper(0x05, 0x0e, 0x24, True);
        },
        exit_north_1 = @install() {
            debug_subtext("S=4");
        },
        exit_south = @install() {
            debug_subtext("S=5");
        },
        exit_north_2 = @install() {
            debug_subtext("S=6");
        },
        stepon_7 = @install() {
            debug_subtext("S=7");
        },
        exit_east = @install() {
            debug_subtext("S=8");
        },
    }

    fun trigger_enter() {
        // 0-1 glitchy?
        // object[0x02] = 0x01; // open door
        // 2-7 glitchy?
        // object[0x08] = 0x01; // show rubble_1 (stone)
        // object[0x09] = 0x01; // show rubble_2 (stone)
        // a?
        // object[0x0b] = 0x01; // show rubble_3 (stone)
        // object[0x0c] = 0x01; // show rubble_4 (stone)
        // d?
        // object[0x0e] = 0x01; // show rubble_5 (pebble)
        // object[0x0f] = 0x01; // show rubble_6 (pebble)
        // object[0x10] = 0x7e; // show collapsing_door
        // object[0x11] = 0x01; // show pillars_center_damage
        // object[0x12] = 0x01; // show pillars_east_damage
        // object[0x13] = 0x01; // show pillars_north_west_damage
        // object[0x14] = 0x01; // show pillars_west_damage
        // object[0x15] = 0x01; // remove torch_fire_1
        // object[0x16] = 0x01; // remove torch_fire_3
        // object[0x17] = 0x01; // open door_secret

        fade_in();
    }
};

map ivor_queens(IVOR_THRONE) {
    enum entrance {
        south = entrance(0x1f, 0x57, NORTH),
        west_1 = entrance(0x03, 0x35, EAST),
        west_2 = entrance(0x03, 0x1a, EAST),
    }

    enum stepon_trigger {
        key = @install() {
            debug_subtext("S=0");
        },
        exit_south = @install() {
            debug_subtext("S=1");
        },
        west_1 = @install() {
            debug_subtext("S=2");
        },
        west_2 = @install() {
            debug_subtext("S=3");
        },
    }

    fun trigger_enter() {
        fade_in();
    }
};

map ivor_dining(IVOR_BANQUET) {
    enum entrance {
        test = entrance(0x10, 0x10, NORTH),

        east = entrance(0x3b, 0x21, WEST),
        south = entrance(0x1e, 0x39, NORTH),
    }

    enum stepon_trigger {
        exit_east = @install() {
            debug_subtext("S=0");
        },
        exit_south = @install() {
            debug_subtext("S=1");
        },
    }

    enum b_trigger {
        chest_west = @install() {
            debug_subtext("B=0");
            _loot_chest(0x18, WATER, 0d03);
        },
        chest_east = @install() {
            debug_subtext("B=1");
            _loot_chest(0x19, WAX, 0d02);
        },
    }

    fun trigger_enter() {
        // object[0x00] = 0x01; // open door
        // object[0x01] = 0x02; // show guest_1_2
        // object[0x02] = 0x02; // show guest_1_1
        // object[0x03] = 0x02; // show guest_2_1
        // object[0x04] = 0x02; // show guest_2_2
        // object[0x05] = 0x02; // show guest_2_3
        // object[0x06] = 0x02; // show guest_2_4
        // object[0x07] = 0x02; // show guest_1_4
        // object[0x08] = 0x01; // show plate_queen
        // object[0x09] = 0x01; // show plate_left
        // object[0x0a] = 0x01; // show plate_bottom_1
        // object[0x0b] = 0x01; // show plate_bottom_2
        // object[0x0c] = 0x01; // show plate_top
        // object[0x0d] = 0x01; // hide fire_1
        // object[0x0e] = 0x01; // hide fire_2
        // object[0x0f] = 0x01; // show rubble_table_center
        // object[0x10] = 0x01; // show rubble_table_right
        // object[0x11] = 0x01; // show rubble_table_left
        // object[0x12] = 0x01; // hide plate_1_2
        // object[0x13] = 0x01; // show rubble_table
        // object[0x14] = 0x01; // show rubble_left
        // object[0x15] = 0x01; // show rubble_right
        // object[0x16] = 0x01; // show peples_top
        // object[0x17] = 0x01; // show peples_south
        // object[0x18] = 0x01; // loot chest_west
        // object[0x19] = 0x01; // loot chest_east

        fade_in();

        <0x2834> = 0x00;
        while(True) {
            <0x2836> = 0x00;
            while(<0x2836> < 0d3) {
                debug_memory(<0x2834>, <0x2836>);
                object[<0x2834>] = <0x2836>;
                sleep(0x50);
                <0x2836> += 0x01;
            }
            debug_memory(<0x2834>, 0x7e);
            object[<0x2834>] = 0x7e;
            sleep(0x50);
        }

    }
};

map ivor_rooms(IVOR_ROOMS_1) {
    enum entrance {
        east = entrance(0xe5, 0x91, WEST),
        west = entrance(0x07, 0x91, EAST),

        stairs_east = entrance(0xed, 0x58, WEST), // entrance(0xe9, 0x58, WEST),
        stairs_west = entrance(0x00, 0x59, EAST), // entrance(0x03, 0x58, EAST)

        stairs = entrance(0xd8, 0x23, SOUTH),
    }

    enum stepon_trigger {
        room_2_3_hidden_entrance = @install() {
            debug_subtext("S=0");
        },
        vent_kitchen = @install() {
            debug_subtext("S=1");
        },
        room_3_4_vent = @install() {
            debug_subtext("S=2");
        },
        room_3_3_vent = @install() {
            debug_subtext("S=3");
        },
        room_3_2_vent = @install() {
            debug_subtext("S=4");
        },
        room_2_3_vent = @install() {
            debug_subtext("S=5");
        },
        room_2_4_vent = @install() {
            debug_subtext("S=6");
        },
        room_2_5_vent = @install() {
            debug_subtext("S=7");
        },
        room_2_6_vent = @install() {
            debug_subtext("S=8");
        },
        room_1_5_vent = @install() {
            debug_subtext("S=9");
        },

        room_1_4_vent = @install() {
            debug_subtext("S=10");
        },
        room_1_4_vent = @install() {
            debug_subtext("S=11");
        },
        room_1_3_vent = @install() {
            debug_subtext("S=12");
        },
        room_1_1_vent = @install() {
            debug_subtext("S=13");
        },
        room_3_5_vent = @install() {
            debug_subtext("S=14");
        },
        exit_door = @install() {
            debug_subtext("S=15");
        },
        exit_stairs_east = @install() {
            debug_subtext("S=16");
        },
        exit_stairs_west = @install() {
            debug_subtext("S=17");
        },
        exit_west = @install() {
            debug_subtext("S=18");
        },
        exit_east = @install() {
            debug_subtext("S=19");
        },

        room_2_3_hiden_vent = @install() {
            debug_subtext("S=20");
        },
        stepon_21 = @install() {
            debug_subtext("S=21");
        },
        room_1_1_door_outside = @install() {
            debug_subtext("S=22");
        },
        room_1_2_door_outside = @install() {
            debug_subtext("S=23");
        },
        room_1_3_door_outside = @install() {
            debug_subtext("S=24");
        },
        room_1_4_door_ouside = @install() {
            debug_subtext("S=25");
        },
        room_1_4_door_outside = @install() {
            debug_subtext("S=26");
        },
        room_1_5_door_ouside = @install() {
            debug_subtext("S=27");
        },
        room_2_6_door_outside = @install() {
            debug_subtext("S=28");
        },
        room_2_5_door_outside = @install() {
            debug_subtext("S=29");
        },

        room_2_4_door_outside = @install() {
            debug_subtext("S=30");
        },
        room_2_2_door_ouside = @install() {
            debug_subtext("S=31");
        },
        room_2_2_door_outside = @install() {
            debug_subtext("S=32");
        },
        room_2_1_door_outside = @install() {
            debug_subtext("S=33");
        },
        room_3_1_door_ouside = @install() {
            debug_subtext("S=34");
        },
        room_3_2_door_ouside = @install() {
            debug_subtext("S=35");
        },
        room_3_3_door_ouside = @install() {
            debug_subtext("S=36");
        },
        room_3_4_door_ouside = @install() {
            debug_subtext("S=37");
        },
        room_3_5_door_ouside = @install() {
            debug_subtext("S=38");
        },
        door_kitchen = @install() {
            debug_subtext("S=39");
        },

        room_1_1_door_inside = @install() {
            debug_subtext("S=40");
        },
        room_1_2_door_inside = @install() {
            debug_subtext("S=41");
        },
        room_1_3_door_inside = @install() {
            debug_subtext("S=42");
        },
        room_1_4_door_inside = @install() {
            debug_subtext("S=43");
        },
        room_1_4_door_inside = @install() {
            debug_subtext("S=44");
        },
        room_1_5_door_inside = @install() {
            debug_subtext("S=45");
        },
        room_2_6_door_inside = @install() {
            debug_subtext("S=46");
        },
        room_2_5_door_inside = @install() {
            debug_subtext("S=47");
        },
        room_2_4_door_inside = @install() {
            debug_subtext("S=48");
        },
        room_2_3_door_inside = @install() {
            debug_subtext("S=49");
        },

        room_2_2_door_inside = @install() {
            debug_subtext("S=50");
        },
        room_2_1_door_inside = @install() {
            debug_subtext("S=51");
        },
        room_3_1_door_inside = @install() {
            debug_subtext("S=52");
        },
        room_3_2_door_inside = @install() {
            debug_subtext("S=53");
        },
        room_3_3_door_inside = @install() {
            debug_subtext("S=54");
        },
        room_3_4_door_inside = @install() {
            debug_subtext("S=55");
        },
        room_3_5_door_inside = @install() {
            debug_subtext("S=56");
        },
    }

    enum b_trigger {
        sniff__1_ethanol_2 = @install() {
            debug_subtext("B=0");
            _loot_chest(0x47, ETHANOL, 0d02);
        },
        sniff__1_ethanol_3 = @install() {
            debug_subtext("B=1");
            _loot_chest(0x46, ETHANOL, 0d03);
        },
        sniff__1_ethanol_3 = @install() {
            debug_subtext("B=2");
            _loot_chest(0x45, ETHANOL, 0d03);
        },
        sniff__1_ethanol_2 = @install() {
            debug_subtext("B=3");
            _loot_chest(0x44, ETHANOL, 0d02);
        },
        sniff__1_water_1 = @install() {
            debug_subtext("B=4");
            _loot_chest(0x43, WATER, 0d01);
        },
        sniff__1_water_1 = @install() {
            debug_subtext("B=5");
            _loot_chest(0x42, WATER, 0d01);
        },
        sniff__1_ash_3 = @install() {
            debug_subtext("B=6");
            _loot_chest(0x41, ASH, 0d03);
        },
        sniff__1_ash_2 = @install() {
            debug_subtext("B=7");
            _loot_chest(0x40, ASH, 0d02);
        },
        sniff__1_roots_1 = @install() {
            debug_subtext("B=8");
            _loot_chest(0x3f, ROOTS, 0d01);
        },
        sniff__1_roots_2 = @install() {
            debug_subtext("B=9");
            _loot_chest(0x3e, ROOTS, 0d02);
        },

        sniff__1_roots = @install() {
            debug_subtext("B=10");
            _loot_chest(0x3d, ROOTS, 0d00);
        },
        sniff__1_roots_1 = @install() {
            debug_subtext("B=11");
            _loot_chest(0x3c, ROOTS, 0d01);
        },
        sniff__1_feather_3 = @install() {
            debug_subtext("B=12");
            _loot_chest(0x3b, FEATHER, 0d03);
        },
        sniff__1_feather_1 = @install() {
            debug_subtext("B=13");
            _loot_chest(0x3a, FEATHER, 0d01);
        },
        sniff__1_feather_2 = @install() {
            debug_subtext("B=14");
            _loot_chest(0x39, FEATHER, 0d02);
        },
        sniff__1_brimstone_3 = @install() {
            debug_subtext("B=15");
            _loot_chest(0x38, BRIMSTONE, 0d03);
        },
        sniff__1_brimstone_2 = @install() {
            debug_subtext("B=16");
            _loot_chest(0x37, BRIMSTONE, 0d02);
        },
        sniff__1_brimstone_2 = @install() {
            debug_subtext("B=17");
            _loot_chest(0x36, BRIMSTONE, 0d02);
        },
        sniff__1_mushroom_1 = @install() {
            debug_subtext("B=18");
            _loot_chest(0x35, MUSHROOM, 0d01);
        },
        sniff__1_mushroom_2 = @install() {
            debug_subtext("B=19");
            _loot_chest(0x34, MUSHROOM, 0d02);
        },

        sniff__1_acorns_3 = @install() {
            debug_subtext("B=20");
            _loot(0x33, ACORNS, 0d01, 0d03);
        },
        sniff__1_acorns_2 = @install() {
            debug_subtext("B=21");
            _loot(0x32, ACORNS, 0d01, 0d02);
        },
        sniff__1_acorns = @install() {
            debug_subtext("B=22");
            _loot(0x31, ACORNS, 0d01, 0d00);
        },
        sniff__1_iron_3 = @install() {
            debug_subtext("B=23");
            _loot(0x30, IRON, 0d01, 0d03);
        },
        sniff__1_iron_1 = @install() {
            debug_subtext("B=24");
            _loot(0x2f, IRON, 0d01, 0d01);
        },
        nothing = @install() {
            debug_subtext("B=25");
        },
        room_3_1_chest__1_biscuit = @install() {
            debug_subtext("B=26");
            _loot_chest(0x14, BISCUIT, 0d01);
        },
        room_3_4_chest__1_wings = @install() {
            debug_subtext("B=27");
            _loot_chest(0x13, WINGS, 0d01);
        },
        room_2_6_chest__3_mushrooms = @install() {
            debug_subtext("B=28");
            _loot_chest(0x2e, MUSHROOM, 0d03);
        },
        room_1_2_chest__2_acorns = @install() {
            debug_subtext("B=29");
            _loot_chest(0x15, ACORNS, 0d02);
        },

        room_1_4_chest__2iroon = @install() {
            debug_subtext("B=30");
            _loot_chest(0x16, IRON, 0d02);
        },
        room_1_5_chest__1_honey = @install() {
            debug_subtext("B=31");
            _loot_chest(0x17, HONEY, 0d01);
        },
    }

    fun trigger_enter() {
        // object[0x00] = 0x01; // open room_1_1_door
        // object[0x01] = 0x01; // open room_1_2_door
        // object[0x02] = 0x01; // open room_1_3_door
        // object[0x03] = 0x01; // open room_1_4_door
        // object[0x04] = 0x01; // open room_1_5_door
        // object[0x05] = 0x01; // open room_1_6_door
        // object[0x06] = 0x01; // open door_stairs
        // object[0x07] = 0x01; // open room_2_6_door
        // object[0x08] = 0x01; // open room_2_5_door
        // object[0x09] = 0x01; // open room_2_4_door
        // object[0x0a] = 0x01; // open room_2_3_door
        // object[0x0b] = 0x01; // open room_2_2_door
        // object[0x0c] = 0x01; // open room_2_1_door
        // object[0x0d] = 0x01; // open room_3_1_door
        // object[0x0e] = 0x01; // open room_3_2_door
        // object[0x0f] = 0x01; // open room_3_3_door
        // object[0x10] = 0x01; // open room_3_4_door
        // object[0x11] = 0x01; // open room_3_5_door
        // object[0x12] = 0x01; // open door_kitchen
        // object[0x13] = 0x01; // open room_3_4_chest
        // object[0x14] = 0x01; // open room_3_1_chest
        // object[0x15] = 0x01; // open room_1_2_chest
        // object[0x16] = 0x01; // open room_1_5_chest
        // object[0x17] = 0x01; // open room_1_6_chest
        // sniff spots?
        // object[0x2e] = 0x01; // open room_2_6_chest

        fade_in();
    }
};

map ivor_dog_maze(DOG_MAZE) {
    enum entrance {
        test = entrance(0x0a, 0x23, NORTH),
    }

    enum stepon_trigger {
        stepon_0 = @install() {
            debug_subtext("S=0");
        },
        stepon_1 = @install() {
            debug_subtext("S=1");
        },
        stepon_2 = @install() {
            debug_subtext("S=2");
        },
        stepon_3 = @install() {
            debug_subtext("S=3");
        },
        stepon_4 = @install() {
            debug_subtext("S=4");
        },
        stepon_5 = @install() {
            debug_subtext("S=5");
        },
        stepon_6 = @install() {
            debug_subtext("S=6");
        },
        stepon_7 = @install() {
            debug_subtext("S=7");
        },
        stepon_8 = @install() {
            debug_subtext("S=8");
        },
        stepon_9 = @install() {
            debug_subtext("S=9");
        },

        stepon_10 = @install() {
            debug_subtext("S=10");
        },
        stepon_11 = @install() {
            debug_subtext("S=11");
        },
        stepon_12 = @install() {
            debug_subtext("S=12");
        },
        stepon_13 = @install() {
            debug_subtext("S=13");
        },
        stepon_14 = @install() {
            debug_subtext("S=14");
        },
        stepon_15 = @install() {
            debug_subtext("S=15");
        },
        stepon_16 = @install() {
            debug_subtext("S=16");
        },
        stepon_17 = @install() {
            debug_subtext("S=17");
        },
        stepon_18 = @install() {
            debug_subtext("S=18");
        },
        stepon_19 = @install() {
            debug_subtext("S=19");
        },

        stepon_20 = @install() {
            debug_subtext("S=20");
        },
        stepon_21 = @install() {
            debug_subtext("S=21");
        },
        stepon_22 = @install() {
            debug_subtext("S=22");
        },
        stepon_23 = @install() {
            debug_subtext("S=23");
        },
        stepon_24 = @install() {
            debug_subtext("S=24");
        },
        stepon_25 = @install() {
            debug_subtext("S=25");
        },
        stepon_26 = @install() {
            debug_subtext("S=26");
        },
        stepon_27 = @install() {
            debug_subtext("S=27");
        },
    }

    fun trigger_enter() {
        fade_in();
    }
};

map ivor_stairs(IVOR_STAIRS) {
    enum entrance {
        door_upstairs = entrance(0x0a, 0x23, NORTH),
        door_downstairs = entrance(0x22, 0x45, NORTH),
    }

    enum stepon_trigger {
        exit_door_upstairs = @install() {
            debug_subtext("S=0");
        },
        exit_door_downstairs = @install() {
            debug_subtext("S=1");
        },
    }

    fun trigger_enter() {
        fade_in();
    }
};

map ebon_court(EBON_COURT) {
    enum entrance {
        north = entrance(0x11, 0x14, SOUTH),
        side_left = entrance(0x06, 0x23, SOUTH),
        side_right = entrance(0x22, 0x23, SOUTH),
        south = entrance(0x13, 0x4d, NORTH),
    }

    enum stepon_trigger {
        exit_side_right = @install() {
            debug_subtext("S=0");
        },
        exit_side_left = @install() {
            debug_subtext("S=1");
        },
        exit_south = @install() {
            debug_subtext("S=2");
        },
        gate_north = @install() {
            debug_subtext("S=3");
        },
        gate_side_left = @install() {
            debug_subtext("S=4");
        },
        gate_side_right = @install() {
            debug_subtext("S=5");
        },
        exit_north = @install() {
            debug_subtext("S=6");
        },
    }

    fun trigger_enter() {
        // object[0x00] = 0x7e; // open gate_north
        // object[0x01] = 0x7e; // open gate_side_left
        // object[0x02] = 0x7e; // open gate_side_right

        fade_in();
    }
};

map verminator(VERMINATOR) {
    enum entrance {
        north = entrance(0x16, 0x09, SOUTH),
        east = entrance(0x29, 0x38, WEST),
        south = entrance(0x16, 0x65, NORTH),
        west = entrance(0x03, 0x38, EAST),
        stairs = entrance(0x19, 0x4d, EAST)
    }

    enum stepon_trigger {
        exit_north = @install() {
            debug_subtext("S=0");
        },
        stepon_1 = @install() {
            debug_subtext("S=1");
        },
        stepon_2 = @install() {
            debug_subtext("S=2");
        },
        stepon_3 = @install() {
            debug_subtext("S=3");
        },
        stepon_4 = @install() {
            debug_subtext("S=4");
        },
        spawn_boss = @install() {
            debug_subtext("S=5");
        },
        exit_stairs = @install() {
            debug_subtext("S=6");
            // map_transition(verminator, south, WEST);
        },
        exit_south = @install() {
            debug_subtext("S=7");
            // map_transition(verminator, north, SOUTH);
        },
        exit_west = @install() {
            debug_subtext("S=8");
            // map_transition(verminator, east, WEST);
        },
        exit_east = @install() {
            debug_subtext("S=9");
            // map_transition(verminator, west, EAST);
        }
    }

    fun trigger_enter() {
        fade_in();
    }
};

map ebon_verminator_side_rooms(EBON_COURT_SIDEROOMS) {
    enum entrance {
        left_east = entrance(0x21, 0x30, WEST),
        left_south = entrance(0x10, 0x6d, NORTH),

        right_south = entrance(0x5c, 0x6d, EAST),
        right_west = entrance(0x47, 0x30, NORTH),
    }

    enum stepon_trigger {
        exit_left_south = @install() {
            debug_subtext("S=0");
        },
        exit_right_south = @install() {
            debug_subtext("S=1");
        },
        exit_left_east = @install() {
            debug_subtext("S=2");
        },
        exit_right_west = @install() {
            debug_subtext("S=3");
        },
    }

    fun trigger_enter() {
        fade_in();
    }
};

map ebon_cellar(EBON_CELLAR) {
    enum entrance {
        stairs = entrance(0x29, 0x0d, WEST)
    }

    enum stepon_trigger {
        stepon_0 = @install() {
            debug_subtext("S=0");
        },
    }

    enum b_trigger {
        chest_1__3_feather = @install() {
            debug_subtext("B=0");
            _loot_chest(0x00, FEATHER, 0d03);
        },
        chest_2__4_brimstone = @install() {
            debug_subtext("B=1");
            _loot_chest(0x01, BRIMSTONE, 0d04);
        },
        chest_3__2_acorns = @install() {
            debug_subtext("B=2");
            _loot_chest(0x02, ACORNS, 0d02);
        },
    }

    fun trigger_enter() {
        // object[0x00] = 0x01; // open chest_1
        // object[0x01] = 0x01; // open chest_2
        // object[0x02] = 0x01; // open chest_3

        fade_in();
    }
};

map ebon_after_verminator(EBON_HALL) {
    enum entrance {
        test = entrance(0x10, 0x10, NONE),

        north_1 = entrance(0x14, 0x4b, SOUTH),
        north_2 = entrance(0x40, 0x11, SOUTH),
        south = entrance(0x25, 0x75, NORTH),
        west = entrance(0x07, 0x53, EAST),
    }

    enum stepon_trigger {
        exit_west = @install() {
            debug_subtext("S=0");
        },
        exit_north_1 = @install() {
            debug_subtext("S=1");
        },
        exit_south = @install() {
            debug_subtext("S=2");
        },
        exit_north_2 = @install() {
            debug_subtext("S=3");
        },
        stairs_helper_1 = @install() {
            debug_subtext("S=4");

            vanilla_a3_stairs_helper(0x04, 0x44, 0x34, True);
        },
        stairs_helper_2 = @install() {
            debug_subtext("S=5");

            vanilla_a3_stairs_helper(0x04, 0x44, 0x2e, False);
        },
        stairs_helper_3 = @install() {
            debug_subtext("S=6");

            vanilla_a3_stairs_helper(0x03, 0x44, 0x24, True);
        },
        stairs_helper_4 = @install() {
            debug_subtext("S=7");

            vanilla_a3_stairs_helper(0x03, 0x44, 0x1e, False);
        },
    }

    fun trigger_enter() {
        // object[0x00] = 0x01; // hide statue
        // object[0x01] = 0x01; // hide rubble
        // 2-4 ?
        // object[0x05] = 0x01; // open door
        // >5 ?

        fade_in();
    }
};

map ebon_dining_room(EBON_BANQUET) {
    enum entrance {
        south = entrance(0x22, 0x3b, NORTH),
        west = entrance(0x05, 0x21, EAST),
    }

    enum stepon_trigger {
        exit_south = @install() {
            debug_subtext("S=0");
        },
        exit_west = @install() {
            debug_subtext("S=1");
        },
    }

    enum b_trigger {
        gourd = @install() {
            debug_subtext("B=0");
            _loot_chest(0x19, WAX, 0d02);
        },
    }

    fun trigger_enter() {
        // object[0x00] = 0x01; // open chest
        
        fade_in();
    }
};

map naris(NARIS) {
    enum entrance {
        east = entrance(0x77, 0x29, WEST),
        west = entrance(0x07, 0x28, EAST),
    }

    enum stepon_trigger {
        exit_west = @install() {
            debug_subtext("S=0");
        },
        exit_east = @install() {
            debug_subtext("S=1");
        },
    }

    enum b_trigger {
        gourd_north__8_oil = @install() {
            debug_subtext("B=0");
            _loot_chest(0x07, OIL, 0d08);
        },
        gourd_south__500_money = @install() {
            debug_subtext("B=1");
            _loot_chest(0x03, MONEY, 0d500);
        },
    }

    fun trigger_enter() {
        // object[0x03] = 0x01; // open gourd_south
        object[0x02] = 0x01; // close door_south_1
        // object[0x01] = 0x01; // close door_south_2
        // object[0x00] = 0x01; // close door_south_3

        // object[0x07] = 0x01; // open gourd_north
        // object[0x04] = 0x01; // close door_north_1
        // object[0x05] = 0x01; // close door_north_2
        // object[0x06] = 0x01; // close door_north_3

        fade_in();
    }
};

map ebon_queen(EBON_THRONE) {
    enum entrance {
        east = entrance(0x37, 0x34, WEST),
        south = entrance(0x1b, 0x55, NORTH), // entrance(0x1b, 0x59, NORTH),
    }

    enum stepon_trigger {
        exit_east = @install() {
            debug_subtext("S=0");
        },
        exit_south = @install() {
            debug_subtext("S=1");
        },
    }

    fun trigger_enter() {
        fade_in();
    }
};

map ebon_glass(EBON_GLASS) {
    enum entrance {
        east = entrance(0x2d, 0x19, WEST),
        west = entrance(0x03, 0x19, EAST),
    }

    enum stepon_trigger {
        exit_east = @install() {
            debug_subtext("S=0");
        },
        exit_west = @install() {
            debug_subtext("S=1");
        },
    }

    fun trigger_enter() {
        // object[0x00] = 0x01; // hide image_1
        // object[0x01] = 0x01; // hide image_2
        // object[0x02] = 0x01; // hide image_3
        // object[0x03] = 0x01; // hide image_4
        // object[0x04] = 0x01; // hide image_5

        fade_in();
    }
};

map tinker(TINKER) {
    enum entrance {
        test = entrance(0x3a, 0x33, WEST),

        east = entrance(0x3a, 0x33, WEST),
        west = entrance(0x03, 0x33, EAST),
    }

    enum stepon_trigger {
        exit_east = @install() {
            debug_subtext("S=0");
        },
        exit_west = @install() {
            debug_subtext("S=1");
        },
    }

    enum b_trigger {
        shelf = @install() {
            debug_subtext("B=0");
        },
        chest = @install() {
            debug_subtext("B=1");
        },
        scroll = @install() {
            debug_subtext("B=2");
        },
    }

    fun trigger_enter() {
        // object[0x00] = 0x01; // open chest
        // object[0x01] = 0x01; // hide scrol

        fade_in();
    }
};

map tinker_fire_pit(TINKER_EXTERIOR) {
    enum entrance {
        west = entrance(0x0f, 0x35, EAST),
    }

    enum stepon_trigger {
        windwalker = @install() {
            debug_subtext("S=0");
        },
        exit_west = @install() {
            debug_subtext("S=1");
        },
    }

    fun trigger_enter() {
        // object[0x00] = 0x01; // open tower
        // object[0x01] = 0x01; // ignite fire
        // object[0x02] = 0x01; // show windwalker_collision

        fade_in();
    }
};

map sterling(STERLING) {
    enum entrance {
        south = entrance(0x55, 0xf9, NORTH),
        platform = entrance(0x51, 0x2f, NORTH)
    }

    enum stepon_trigger {
        elevator_bottom = @install() {
            debug_subtext("S=0");

            generic_elevator_gomi(0x3e, 0xcf, 0x01, 0x01, 0d62, 0d77, 0x04, 0x01);
        },
        elevator_top = @install() {
            debug_subtext("S=1");

            generic_elevator_gomi(0x3e, 0x4e, 0x04, 0x01, 0d62, 0d205, 0x01, 0x01);
        },
        spawn_boss = @install() {
            debug_subtext("S=2");
        },
        trapdoor_4 = @install() {
            debug_subtext("S=3");
        },
        exit_south = @install() {
            debug_subtext("S=4");
            // map_transition(sterling, platform, SOUTH);
        },
        trapdoor_1 = @install() {
            debug_subtext("S=5");
        },
        stepon_6 = @install() {
            debug_subtext("S=6");
        },
        trapdoor_4_open = @install() {
            debug_subtext("S=7");
        },
        trapdoor_2 = @install() {
            debug_subtext("S=8");
        },
        stepon_9 = @install() {
            debug_subtext("S=9");
        },

        trapdoor_3 = @install() {
            debug_subtext("S=10");
        },
        stepon_11 = @install() {
            debug_subtext("S=11");
        }
    }

    enum b_trigger {
        sniff__1_water_2 = @install() {
            debug_subtext("B=0");
            _loot(0x1c, WATER, 0d01, 0d02);
        },
        sniff__1_water_4 = @install() {
            debug_subtext("B=1");
            _loot(0x1b, WATER, 0d01, 0d04);
        },
        sniff__1_acorns_2 = @install() {
            debug_subtext("B=2");
            _loot(0x1a, ACORNS, 0d01, 0d02);
        },
        sniff__1_acorns_1 = @install() {
            debug_subtext("B=3");
            _loot(0x19, ACORNS, 0d01, 0d01);
        },
        sniff__1_mushroom_3 = @install() {
            debug_subtext("B=4");
            _loot(0x18, MUSHROOM, 0d01, 0d03);
        },
        sniff__1_mushroom_1 = @install() {
            debug_subtext("B=5");
            _loot(0x17, MUSHROOM, 0d01, 0d01);
        },
        sniff__1_roots = @install() {
            debug_subtext("B=6");
            _loot(0x16, ROOTS, 0d01, 0d00);
        },
        sniff__1_roots_2 = @install() {
            debug_subtext("B=7");
            _loot(0x15, ROOTS, 0d01, 0d02);
        },
        sniff__1_feather_2 = @install() {
            debug_subtext("B=8");
            _loot(0x14, FEATHER, 0d01, 0d02);
        },
        sniff__1_feather_3 = @install() {
            debug_subtext("B=9");
            _loot(0x13, FEATHER, 0d01, 0d03);
        },

        sniff__1_feather_1 = @install() {
            debug_subtext("B=10");
            _loot(0x12, FEATHER, 0d01, 0d01);
        },
        sniff__1_iron = @install() {
            debug_subtext("B=11");
            _loot(0x11, IRON, 0d01, 0d00);
        },
        sniff__1_iron_2 = @install() {
            debug_subtext("B=12");
            _loot(0x10, IRON, 0d01, 0d02);
        },
        sniff__1_ash_2 = @install() {
            debug_subtext("B=13");
            _loot(0x0f, ASH, 0d01, 0d02);
        },
        sniff__1_ash_1 = @install() {
            debug_subtext("B=14");
            _loot(0x0e, ASH, 0d01, 0d01);
        },
        sniff__1_ethanol_2 = @install() {
            debug_subtext("B=15");
            _loot(0x0d, ETHANOL, 0d01, 0d02);
        },
        sniff__1_ethanol_2 = @install() {
            debug_subtext("B=16");
            _loot(0x0c, ETHANOL, 0d01, 0d02);
        },
        sniff__1_ethanol_1 = @install() {
            debug_subtext("B=17");
            _loot(0x0b, ETHANOL, 0d01, 0d01);
        },
        gourd_x__1_feather = @install() {
            debug_subtext("B=18");
            _loot_chest(0x09, FEATHER, 0d01);
        },
        gourd_x__1_acorn = @install() {
            debug_subtext("B=19");
            _loot_chest(0x08, ACORNS, 0d01);
        },

        gourd_x__1_ash = @install() {
            debug_subtext("B=20");
            _loot_chest(0x02, ASH, 0d01);
        },
        gourd_x__1_ethanol = @install() {
            debug_subtext("B=21");
            _loot_chest(0x00, ETHANOL, 0d01);
        }
    }

    fun trigger_enter() {
        // object[0x00] = 0x01; // open chest_2
        // object[0x01] = 0x01; // open elevator_bottom
        // object[0x02] = 0x01; // open chest_3
        // object[0x03] = 0x01; // activate trapdoor_4
        // object[0x04] = 0x01; // open elevator_top
        // object[0x05] = 0x03; // activate trapdoor_2
        // object[0x06] = 0x03; // activate trapdoor_3
        // object[0x07] = 0x03; // activate trapdoor_1
        // object[0x08] = 0x01; // open chest_1
        // object[0x09] = 0x01; // open chest_4
        // object[0x0a] = 0x01; // block elevator_top

        fade_in();
    }
};

map mungola(MUNGOLA) {
    enum entrance {
        east_1 = entrance(0x39, 0x15, WEST),
        east_2 = entrance(0x39, 0x24, WEST)
    }

    enum stepon_trigger {
        stairs = @install() {
            debug_subtext("S=0");
        },
        exit_east_1 = @install() {
            debug_subtext("S=1");
        },
        exit_east_2 = @install() {
            debug_subtext("S=2");
        }
    }

    fun trigger_enter() {
        // object[0x00] = 0x01; // shake banner_2
        // object[0x01] = 0x01; // shake banner_4
        // object[0x02] = 0x01; // shake banner_5
        // object[0x03] = 0x01; // shake banner_1
        // object[0x04] = 0x01; // shake banner_3
        // object[0x05] = 0x01; // change mungola_1 (scalp - 0:hidden, 1:shown, 2:dead)
        // object[0x06] = 0x01; // change mungola_2 (eye_left - 0:hidden, 1:hidden_wink, 2:shown, 3:dead)
        // object[0x07] = 0x01; // change mungola_3 (mouth_left - 0:hidden, 2:shown, 3:shown_teeth, 4:dead)
        // object[0x08] = 0x01; // shake banner_2_more
        // object[0x09] = 0x01; // change mungola_4 (eye_right - 0:hidden, 1:hidden_wink, 2:shown, 3:dead)
        // object[0x0a] = 0x01; // change mungola_5 (mouth_left - 0:hidden, 2:shown, 3:shown_teeth, 4:dead)
        // object[0x0b] = 0x01; // change mungola_6 (chin - 0:hidden, 1:shown, 2:dead)
        // object[0x0c] = 0x01; // open hole
        // object[0x0d] = 0x01; // unblock stairs
        // object[0x0e] = 0x01; // close exit_east_2

        fade_in();
    }
};

// act 4

map junkyard(OMNITOPIA_JUNKYARD) {
    enum entrance {
        north = entrance(0d62, 0d22, NONE, { door_act4_beam_in(); }),
        teleporter = entrance(0d21, 0d79, NONE, { teleporter_in(SOUTH); }),

        crash = entrance(0x3a, 0x4e, NONE),
    }

    enum stepon_trigger {
        stepon_0 = @install() {
            debug_subtext("S=0");
        },
        stepon_1 = @install() {
            debug_subtext("S=1");
        },
        stepon_2 = @install() {
            debug_subtext("S=2");
        },
        stepon_3 = @install() {
            debug_subtext("S=3");
        },
        stepon_4 = @install() {
            debug_subtext("S=4");
        },
        stepon_5 = @install() {
            debug_subtext("S=5");
        },
        stepon_6 = @install() {
            debug_subtext("S=6");
        },
        stepon_7 = @install() {
            debug_subtext("S=7");
        },
        stepon_8 = @install() {
            debug_subtext("S=8");
        },
        stepon_9 = @install() {
            debug_subtext("S=9");
        },

        stepon_10 = @install() {
            debug_subtext("S=10");
        },
        exit_north = @install() {
            debug_subtext("S=11");

            door_act4_beam_out(0d62, 0d22);
        },
        teleporter = @install() {
            debug_subtext("S=12");
        },
    }
    
    fun trigger_enter() {
        fade_in();

        // object[0x00] = 0x01; // activate teleporter
        // object[0x01] = 0x01; // activate machine_top
        // object[0x02] = 0x01; // activate machine_left
        // object[0x03] = 0x01; // activate machine_right
        // object[0x04] = 0x01; // hide rocket
    }
};

map jail(OMNITOPIA_JAIL) {
    enum entrance {
        east = entrance(0xc6, 0x14, NONE),
        west = entrance(0x0e, 0x1c, NONE),
    }

    enum stepon_trigger {
        exit_east = @install() {
            debug_subtext("S=0");
        },
    }
    
    enum b_trigger {
        sniff__1_brimstone_2 = @install() {
            debug_subtext("B=0");
            _loot(0x15, BRIMSTONE, 0d01, 0d02);
        },
        sniff__1_brimstone_1 = @install() {
            debug_subtext("B=1");
            _loot(0x14, BRIMSTONE, 0d01, 0d01);
        },
        sniff__1_wax_2 = @install() {
            debug_subtext("B=2");
            _loot(0x13, WAX, 0d01, 0d02);
        },
        sniff__1_crystal_1 = @install() {
            debug_subtext("B=3");
            _loot(0x12, CRYSTAL, 0d01, 0d01);
        },
        sniff__1_iron = @install() {
            debug_subtext("B=4");
            _loot(0x11, IRON, 0d01, 0d00);
        },
        sniff__1_iron_1 = @install() {
            debug_subtext("B=5");
            _loot(0x10, IRON, 0d01, 0d01);
        },
        sniff__1_dry_ice_2 = @install() {
            debug_subtext("B=6");
            _loot(0x0f, DRY_ICE, 0d01, 0d02);
        },
        sniff__1_dry_meteorite_3 = @install() {
            debug_subtext("B=7");
            _loot(0x0e, METEORITE, 0d01, 0d03);
        },
        sniff__1_grease_1 = @install() {
            debug_subtext("B=8");
            _loot(0x0d, GREASE, 0d01, 0d01);
        },
        sniff__1_grease_2 = @install() {
            debug_subtext("B=9");
            _loot(0x0c, GREASE, 0d01, 0d02);
        },

        sniff__1_gunpowder_2 = @install() {
            debug_subtext("B=10");
            _loot(0x0b, GUNPOWDER, 0d01, 0d02);
        },
        sniff__1_gunpowder_1 = @install() {
            debug_subtext("B=11");
            _loot(0x0a, GUNPOWDER, 0d01, 0d01);
        },
        exit_west = @install() {
            debug_subtext("B=12");
        },
        lever_4 = @install() {
            debug_subtext("B=13");
        },
        lever_3 = @install() {
            debug_subtext("B=14");
        },
        lever_2 = @install() {
            debug_subtext("B=15");
        },
        lever_1 = @install() {
            debug_subtext("B=16");
        },
    }

    fun trigger_enter() {
        // object[0x00] = 0x7e; // open door_west
        // object[0x01] = 0x7e; // open prison_3
        // object[0x02] = 0x7e; // open prison_4
        // object[0x03] = 0x7e; // open prison_2
        // object[0x04] = 0x7e; // activate lever_1
        // object[0x05] = 0x7e; // activate lever_2
        // object[0x06] = 0x7e; // activate lever_3
        // object[0x07] = 0x7e; // activate lever_4
        // object[0x08] = 0x7e; // open prison_1
        // sniff spots

        fade_in();
    }
};

map metro(OMNITOPIA_METROPLEX) {
    enum ROOM {
        ROW_1 = 0d18,
        ROW_2 = 0d62,
        ROW_3 = 0d106,
        ROW_4 = 0d150,

        COLUMN_1 = 0d18,
        COLUMN_2 = 0d82,
        COLUMN_3 = 0d146,
        COLUMN_4 = 0d210,
    }

    enum entrance {
        door_a1 = entrance(ROOM.COLUMN_1, ROOM.ROW_1, NONE, { door_act4_airlock_in(0x0b); }),
        door_a2 = entrance(ROOM.COLUMN_2, ROOM.ROW_1, NONE, { door_act4_airlock_in(0x00); }),
        door_a3 = entrance(ROOM.COLUMN_3, ROOM.ROW_1, NONE, { door_act4_airlock_in(0x0c); }),
        door_a4 = entrance(ROOM.COLUMN_4, ROOM.ROW_1, NONE, { door_act4_airlock_in(0x0d); }),

        door_b2 = entrance(ROOM.COLUMN_2, ROOM.ROW_2, NONE, { door_act4_airlock_in(0x10); }),
        door_b3 = entrance(ROOM.COLUMN_3, ROOM.ROW_2, NONE, { door_act4_airlock_in(0x0f); }),
        door_b4 = entrance(ROOM.COLUMN_4, ROOM.ROW_2, NONE, { door_act4_airlock_in(0x0e); }),

        door_c1 = entrance(ROOM.COLUMN_1, ROOM.ROW_3, NONE, { door_act4_airlock_in(0x11); }),
        door_c2 = entrance(ROOM.COLUMN_2, ROOM.ROW_3, NONE, { door_act4_airlock_in(0x12); }),
        door_c4 = entrance(ROOM.COLUMN_4, ROOM.ROW_3, NONE, { door_act4_airlock_in(0x13); }),

        door_d1 = entrance(ROOM.COLUMN_1, ROOM.ROW_4, NONE, { door_act4_airlock_in(0x16); }),
        door_d3 = entrance(ROOM.COLUMN_3, ROOM.ROW_4, NONE, { door_act4_airlock_in(0x15); }),
        door_d4 = entrance(ROOM.COLUMN_4, ROOM.ROW_4, NONE, { door_act4_airlock_in(0x14); }),
    }

    enum stepon_trigger {
        door_b1_north_south = @install() {
            debug_subtext("S=0");

            // open_cell_exit(0x04, ROOM.DOOR_OPENED_B1_NORTH);
        },
        door_b2_north_south = @install() {
            debug_subtext("S=1");

            // open_cell_exit(0x03, ROOM.DOOR_OPENED_B2_NORTH);
        },
        door_c4_north_south = @install() {
            debug_subtext("S=2");

            // open_cell_exit(0x07, ROOM.DOOR_OPENED_C4_NORTH);
        },
        door_c2_north_south = @install() {
            debug_subtext("S=3");

            // open_cell_exit(0x06, ROOM.DOOR_OPENED_C2_NORTH);
        },
        door_c1_north_south = @install() {
            debug_subtext("S=4");

            // open_cell_exit(0x05, ROOM.DOOR_OPENED_C1_NORTH);
        },
        door_d2_north_south = @install() {
            debug_subtext("S=5");

            // open_cell_exit(0x0a, ROOM.DOOR_OPENED_D2_NORTH);
        },
        door_d3_north_south = @install() {
            debug_subtext("S=6");

            // open_cell_exit(0x09, ROOM.DOOR_OPENED_D3_NORTH);
        },
        door_d4_north_south = @install() {
            debug_subtext("S=7");

            // open_cell_exit(0x08, ROOM.DOOR_OPENED_D4_NORTH);
        },
        door_c4_south_south = @install() {
            debug_subtext("S=8");

            // open_cell_exit(0x1f, ROOM.DOOR_OPENED_C4_SOUTH);
        },
        door_c4_south_north = @install() {
            debug_subtext("S=9");

            // open_cell_exit(0x1f, ROOM.DOOR_OPENED_C4_SOUTH);
        },

        door_c3_south_south = @install() {
            debug_subtext("S=10");

            // open_cell_exit(0x1e, ROOM.DOOR_OPENED_C3_SOUTH);
        },
        door_c3_south_north = @install() {
            debug_subtext("S=11");

            // open_cell_exit(0x1e, ROOM.DOOR_OPENED_C3_SOUTH);
        },
        door_c1_south_south = @install() {
            debug_subtext("S=12");

            // open_cell_exit(0x1d, ROOM.DOOR_OPENED_C1_SOUTH);
        },
        door_c1_south_north = @install() {
            debug_subtext("S=13");

            // open_cell_exit(0x1d, ROOM.DOOR_OPENED_C1_SOUTH);
        },
        door_b1_south_south = @install() {
            debug_subtext("S=14");

            // open_cell_exit(0x1c, ROOM.DOOR_OPENED_B1_SOUTH);
        },
        door_b1_south_north = @install() {
            debug_subtext("S=15");

            // open_cell_exit(0x1c, ROOM.DOOR_OPENED_B1_SOUTH);
        },
        door_b2_south_south = @install() {
            debug_subtext("S=16");

            // open_cell_exit(0x1b, ROOM.DOOR_OPENED_B2_SOUTH);
        },
        door_b2_south_north = @install() {
            debug_subtext("S=17");

            // open_cell_exit(0x1b, ROOM.DOOR_OPENED_B2_SOUTH);
        },
        door_b3_south_south = @install() {
            debug_subtext("S=18");

            // open_cell_exit(0x1a, ROOM.DOOR_OPENED_B3_SOUTH);
        },
        door_b3_south_north = @install() {
            debug_subtext("S=19");

            // open_cell_exit(0x1a, ROOM.DOOR_OPENED_B3_SOUTH);
        },

        door_a4_south_south = @install() {
            debug_subtext("S=20");

            // open_cell_exit(0x19, ROOM.DOOR_OPENED_A4_SOUTH);
        },
        door_a4_south_north = @install() {
            debug_subtext("S=21");

            // open_cell_exit(0x19, ROOM.DOOR_OPENED_A4_SOUTH);
        },
        door_a3_south_south = @install() {
            debug_subtext("S=22");

            // open_cell_exit(0x18, ROOM.DOOR_OPENED_A3_SOUTH);
        },
        door_a3_south_north = @install() {
            debug_subtext("S=23");

            // open_cell_exit(0x18, ROOM.DOOR_OPENED_A3_SOUTH);
        },
        door_a2_south_south = @install() {
            debug_subtext("S=24");

            // open_cell_exit(0x02, ROOM.DOOR_OPENED_A2_SOUTH);
        },
        door_a2_south_north = @install() {
            debug_subtext("S=25");

            // open_cell_exit(0x02, ROOM.DOOR_OPENED_A2_SOUTH);
        },
        door_a1_south_south = @install() {
            debug_subtext("S=26");

            // open_cell_exit(0x17, ROOM.DOOR_OPENED_A1_SOUTH);
        },
        door_a1_south_north = @install() {
            debug_subtext("S=27");

            // open_cell_exit(0x17, ROOM.DOOR_OPENED_A1_SOUTH);
        },
        stepon_28 = @install() {
            debug_subtext("S=28");
        },
        stepon_29 = @install() {
            debug_subtext("S=29");
        },

        stepon_30 = @install() {
            debug_subtext("S=30");
        },
        stepon_31 = @install() {
            debug_subtext("S=31");
        },
        stepon_32 = @install() {
            debug_subtext("S=32");
        },
        stepon_33 = @install() {
            debug_subtext("S=33");
        },
        stepon_34 = @install() {
            debug_subtext("S=34");
        },
        stepon_35 = @install() {
            debug_subtext("S=35");
        },
        stepon_36 = @install() {
            debug_subtext("S=36");
        },
        stepon_37 = @install() {
            debug_subtext("S=37");
        },
        stepon_38 = @install() {
            debug_subtext("S=38");
        },
        stepon_39 = @install() {
            debug_subtext("S=39");
        },

        stepon_40 = @install() {
            debug_subtext("S=40");
        },
        stepon_41 = @install() {
            debug_subtext("S=41");
        },
        stepon_42 = @install() {
            debug_subtext("S=42");
        },
        stepon_43 = @install() {
            debug_subtext("S=43");
        },
        stepon_44 = @install() {
            debug_subtext("S=44");
        },
        stepon_45 = @install() {
            debug_subtext("S=45");
        },
        stepon_46 = @install() {
            debug_subtext("S=46");
        },
        stepon_47 = @install() {
            debug_subtext("S=47");
        },
        door_b1_north_north = @install() {
            debug_subtext("S=48");

            // open_cell_exit(0x04, ROOM.DOOR_OPENED_B1_NORTH);
        },
        door_b2_north_north = @install() {
            debug_subtext("S=49");

            // open_cell_exit(0x03, ROOM.DOOR_OPENED_B2_NORTH);
        },

        door_c1_north_north = @install() {
            debug_subtext("S=50");

            // open_cell_exit(0x05, ROOM.DOOR_OPENED_C1_NORTH);
        },
        door_c2_north_north = @install() {
            debug_subtext("S=51");

            // open_cell_exit(0x06, ROOM.DOOR_OPENED_C2_NORTH);
        },
        door_c4_north_north = @install() {
            debug_subtext("S=52");

            // open_cell_exit(0x07, ROOM.DOOR_OPENED_C4_NORTH);
        },
        door_d4_north_north = @install() {
            debug_subtext("S=53");

            // open_cell_exit(0x08, ROOM.DOOR_OPENED_D4_NORTH);
        },
        door_d3_north_north = @install() {
            debug_subtext("S=54");

            // open_cell_exit(0x09, ROOM.DOOR_OPENED_D3_NORTH);
        },
        door_d2_north_north = @install() {
            debug_subtext("S=55");

            // open_cell_exit(0x0a, ROOM.DOOR_OPENED_D2_NORTH);
        },
    }

    enum b_trigger {
        door_center = @install() {
            debug_subtext("B=0");
        },
        door_d1_down = @install() {
            debug_subtext("B=1");
        },
        door_d1_up = @install() {
            debug_subtext("B=2");

            // cell_up(ROOM.ROW_4, ROOM.COLUMN_1);
        },
        door_d2_up = @install() {
            debug_subtext("B=3");

            // cell_up(ROOM.ROW_4, ROOM.COLUMN_2);
        },
        door_d2_down = @install() {
            debug_subtext("B=4");
        },
        door_d3_up = @install() {
            debug_subtext("B=5");

            // cell_up(ROOM.ROW_4, ROOM.COLUMN_3);
        },
        door_d3_down = @install() {
            debug_subtext("B=6");
        },
        door_d4_up = @install() {
            debug_subtext("B=7");

            // cell_up(ROOM.ROW_4, ROOM.COLUMN_4);
        },
        door_d4_down = @install() {
            debug_subtext("B=8");
        },
        door_c4_up = @install() {
            debug_subtext("B=9");

            // cell_up(ROOM.ROW_3, ROOM.COLUMN_4);
        },

        door_c4_down = @install() {
            debug_subtext("B=10");
        },
        door_c3_up = @install() {
            debug_subtext("B=11");

            // cell_up(ROOM.ROW_3, ROOM.COLUMN_3);
        },
        door_c3_down = @install() {
            debug_subtext("B=12");
        },
        door_c2_up = @install() {
            debug_subtext("B=13");

            // cell_up(ROOM.ROW_3, ROOM.COLUMN_2);
        },
        door_c2_down = @install() {
            debug_subtext("B=14");
        },
        door_c1_up = @install() {
            debug_subtext("B=15");

            // cell_up(ROOM.ROW_3, ROOM.COLUMN_1);
        },
        door_c1_down = @install() {
            debug_subtext("B=16");
        },
        door_b1_up = @install() {
            debug_subtext("B=17");

            // cell_up(ROOM.ROW_2, ROOM.COLUMN_1);
        },
        door_b1_down = @install() {
            debug_subtext("B=18");
        },
        door_b2_up = @install() {
            debug_subtext("B=19");

            // cell_up(ROOM.ROW_2, ROOM.COLUMN_2);
        },

        door_b2_down = @install() {
            debug_subtext("B=20");
        },
        door_b3_up = @install() {
            debug_subtext("B=21");

            // cell_up(ROOM.ROW_2, ROOM.COLUMN_3);
        },
        door_b3_down = @install() {
            debug_subtext("B=22");
        },
        door_b4_up = @install() {
            debug_subtext("B=23");

            // cell_up(ROOM.ROW_2, ROOM.COLUMN_4);
        },
        door_b4_down = @install() {
            debug_subtext("B=24");
        },
        door_a4_up = @install() {
            debug_subtext("B=25");

            // cell_up(ROOM.ROW_1, ROOM.COLUMN_4);
        },
        door_a4_down = @install() {
            debug_subtext("B=26");
        },
        door_a3_up = @install() {
            debug_subtext("B=27");

            // cell_up(ROOM.ROW_1, ROOM.COLUMN_3);
        },
        door_a3_down = @install() {
            debug_subtext("B=28");
        },
        door_a2_up = @install() {
            debug_subtext("B=29");

            // cell_up(ROOM.ROW_1, ROOM.COLUMN_2);
        },

        door_a2_down = @install() {
            debug_subtext("B=30");
        },
        door_a1_up = @install() {
            debug_subtext("B=31");

            // cell_up(ROOM.ROW_1, ROOM.COLUMN_1);
        },
        door_a1_down = @install() {
            debug_subtext("B=32");
        },
        door_d4_center = @install() {
            // door_act4_airlock_out(ROOM.COLUMN_4, ROOM.ROW_4, 0x14);

            debug_subtext("B=33");
        },
        door_d3_center = @install() {
            // door_act4_airlock_out(ROOM.COLUMN_3, ROOM.ROW_4, 0x15);

            debug_subtext("B=34");
        },
        door_b3_center = @install() {
            // door_act4_airlock_out(ROOM.COLUMN_3, ROOM.ROW_2, 0x0f);

            debug_subtext("B=35");
        },
        door_c4_center = @install() {
            // door_act4_airlock_out(ROOM.COLUMN_4, ROOM.ROW_3, 0x13);

            debug_subtext("B=36");
        },
        door_b4_center = @install() {
            // door_act4_airlock_out(ROOM.COLUMN_4, ROOM.ROW_2, 0x0e);

            debug_subtext("B=37");
        },
        door_a4_center = @install() {
            // door_act4_airlock_out(ROOM.COLUMN_4, ROOM.ROW_1, 0x0d);

            debug_subtext("B=38");
        },
        door_a3_center = @install() {
            // door_act4_airlock_out(ROOM.COLUMN_3, ROOM.ROW_1, 0x0c);

            debug_subtext("B=39");
        },

        door_b2_center = @install() {
            // door_act4_airlock_out(ROOM.COLUMN_2, ROOM.ROW_2, 0x10);

            debug_subtext("B=40");
        },
        door_a2_center = @install() {
            // door_act4_airlock_out(ROOM.COLUMN_2, ROOM.ROW_1, 0x00);

            debug_subtext("B=41");
        },
        door_a1_center = @install() {
            // door_act4_airlock_out(ROOM.COLUMN_1, ROOM.ROW_1, 0x0b);

            debug_subtext("B=42");
        },
        door_d1_center = @install() {
            // door_act4_airlock_out(ROOM.COLUMN_1, ROOM.ROW_4, 0x16);

            debug_subtext("B=43");
        },
        door_c1_center = @install() {
            // door_act4_airlock_out(ROOM.COLUMN_1, ROOM.ROW_3, 0x11);

            debug_subtext("B=44");
        },
        door_c2_center = @install() {
            // door_act4_airlock_out(ROOM.COLUMN_2, ROOM.ROW_3, 0x12);

            debug_subtext("B=45");
        },
        b_trigger_46 = @install() {
            debug_subtext("B=46");
        },
        b_trigger_47 = @install() {
            debug_subtext("B=47");
        },
        b_trigger_48 = @install() {
            debug_subtext("B=48");
        },
        b_trigger_49 = @install() {
            debug_subtext("B=49");
        },

        b_trigger_50 = @install() {
            debug_subtext("B=50");
        },
        b_trigger_51 = @install() {
            debug_subtext("B=51");
        },
        b_trigger_52 = @install() {
            debug_subtext("B=52");
        },
    }
    
    fun trigger_enter() {
        fade_in();

        // object[0x00] = 0x7e; // open door_a2_center
        // object[0x01] = 0x7e; // open door_a2_b2
        // object[0x02] = 0x7e; // open door_a2_south
        // object[0x03] = 0x7e; // open door_b2_north
        // object[0x04] = 0x7e; // open door_b1_north
        // object[0x05] = 0x7e; // open door_c1_north
        // object[0x06] = 0x7e; // open door_c2_north
        // object[0x07] = 0x7e; // open door_c4_north
        // object[0x08] = 0x7e; // open door_d4_north
        // object[0x09] = 0x7e; // open door_d3_north
        // object[0x0a] = 0x7e; // open door_d2_north
        // object[0x0b] = 0x7e; // open door_a1_center
        // object[0x0c] = 0x7e; // open door_a3_center
        // object[0x0d] = 0x7e; // open door_a4_center
        // object[0x0e] = 0x7e; // open door_b4_center
        // object[0x0f] = 0x7e; // open door_b3_center
        // object[0x10] = 0x7e; // open door_b2_center
        // object[0x11] = 0x7e; // open door_c1_center
        // object[0x12] = 0x7e; // open door_c2_center
        // object[0x13] = 0x7e; // open door_c4_center
        // object[0x14] = 0x7e; // open door_d4_center
        // object[0x15] = 0x7e; // open door_d3_center
        // object[0x16] = 0x7e; // open door_d1_center
        // object[0x17] = 0x7e; // open door_a1_south
        // object[0x18] = 0x7e; // open door_a3_south
        // object[0x19] = 0x7e; // open door_a4_south
        // object[0x1a] = 0x7e; // open door_b3_south
        // object[0x1b] = 0x7e; // open door_b2_south
        // object[0x1c] = 0x7e; // open door_b1_south
        // object[0x1d] = 0x7e; // open door_c1_south
        // object[0x1e] = 0x7e; // open door_c3_south
        // object[0x1f] = 0x7e; // open door_c4_south
        // object[0x20] = 0x7e; // open door_a1_b1
        // object[0x21] = 0x7e; // open door_b1_c1
        // object[0x22] = 0x7e; // open door_b2_c2
        // object[0x23] = 0x7e; // open door_c3_d3
        // object[0x24] = 0x7e; // open door_c4_d4
        // object[0x25] = 0x7e; // open door_center
        // object[0x26] = 0d01; // open door_a3_a4
        // object[0x27] = 0d01; // open door_b3_b4
        // object[0x28] = 0d01; // open door_c3_c4
        // object[0x29] = 0d01; // open door_d3_d4
        // object[0x2a] = 0d01; // open door_d2_d3
        // object[0x2b] = 0d01; // open door_d1_d2
        // object[0x2c] = 0d01; // open door_c1_c2
        // object[0x2d] = 0d01; // open door_b1_b2
        // object[0x2e] = 0d01; // open door_a1_a2
        // object[0x2f] = 0x7e; // open door_a1_up
        // object[0x30] = 0x7e; // open door_a2_up
        // object[0x31] = 0x7e; // open door_a3_up
        // object[0x32] = 0x7e; // open door_a4_up
        // object[0x33] = 0x7e; // open door_b4_up
        // object[0x34] = 0x7e; // open door_b3_up
        // object[0x35] = 0x7e; // open door_b2_up
        // object[0x36] = 0x7e; // open door_b1_up
        // object[0x37] = 0x7e; // open door_c1_up
        // object[0x38] = 0x7e; // open door_c2_up
        // object[0x39] = 0x7e; // open door_c3_up
        // object[0x3a] = 0x7e; // open door_c4_up
        // object[0x3b] = 0x7e; // open door_d4_up
        // object[0x3c] = 0x7e; // open door_d3_up
        // object[0x3d] = 0x7e; // open door_d2_up
        // object[0x3e] = 0x7e; // open door_d1_up
    }
};

map shopping_district(OMNITOPIA_SHOPPING) {
    enum entrance {
        east = entrance(0d110, 0d19, NONE, { door_act4_beam_in(); }),
        west = entrance(0d10, 0d81, NONE, { door_act4_beam_in(); }),
    }

    enum ROOM {
        DOOR_PASSAGE_SOUTH_OPEN = memory(FLAG, TEMP),
        DOOR_PASSAGE_NORTH_OPEN = memory(FLAG, TEMP),
    }

    enum stepon_trigger {
        exit_west = @install() {
            debug_subtext("S=0");

            door_act4_beam_out(0d10, 0d81);
        },
        exit_east = @install() {
            debug_subtext("S=1");

            door_act4_beam_out(0d110, 0d19);
        },
        door_passage_south_south = @install() {
            debug_subtext("S=2");

            door_act4_passage(0x01, ROOM.DOOR_PASSAGE_SOUTH_OPEN);
        },
        door_passage_south_north = @install() {
            debug_subtext("S=3");

            door_act4_passage(0x01, ROOM.DOOR_PASSAGE_SOUTH_OPEN);
        },
        door_passage_north_south = @install() {
            debug_subtext("S=4");

            door_act4_passage(0x00, ROOM.DOOR_PASSAGE_NORTH_OPEN);
        },
        door_passage_north_north = @install() {
            debug_subtext("S=5");

            door_act4_passage(0x00, ROOM.DOOR_PASSAGE_NORTH_OPEN);
        },
        inn = @install() {
            debug_subtext("S=6");
        },
    }

    enum b_trigger {
        shop_1 = @install() {
            debug_subtext("B=0");
        },
        shop_2 = @install() {
            debug_subtext("B=1");
        },
        shop_3 = @install() {
            debug_subtext("B=2");
        },
    }

    fun trigger_enter() {
        // object[0x00] = 0x7e; // open door_passage_north
        // object[0x01] = 0x7e; // open door_passage_south
        // object[0x02] = 0x7e; // open shop_1
        // object[0x03] = 0x7e; // open shop_2
        // object[0x04] = 0x7e; // open shop_3

        fade_in();
    }
};

map reactor_room(OMNITOPIA_REACTOR) {
    enum entrance {
        north = entrance(0x2c, 0x0d, NONE, { door_act4_beam_in(); }),
        east = entrance(0x3e, 0x3b, NONE, { door_act4_beam_in(); }),

        lever_room = entrance(0x52, 0x0d, NONE, { door_act4_beam_in(); }),
    }

    enum ROOM {
        VENTILATION_ON = False,

        SWITCH = memory(FLAG, TEMP),
    }

    fun update_switch() {
        if(ROOM.SWITCH) {
            object[0x1e] = 0x01; // toggle lever

            object[0x13] = 0x01; // activate machine_top_1

            object[0x1a] = 0x01; // activate machine_top_8
            object[0x1b] = 0x01; // activate machine_front_1
            object[0x1c] = 0x01; // activate machine_front_2
            object[0x1d] = 0x01; // activate machine_front_3
        } else {
            object[0x1e] = 0x00; // toggle lever

            object[0x13] = 0x00; // activate machine_top_1

            object[0x1a] = 0x00; // activate machine_top_8
            object[0x1b] = 0x00; // activate machine_front_1
            object[0x1c] = 0x00; // activate machine_front_2
            object[0x1d] = 0x00; // activate machine_front_3
        }
    }
    fun toggle_switch() {
        ROOM.SWITCH = !ROOM.SWITCH;

        update_switch(ROOM.SWITCH);
    }

    enum stepon_trigger {
        exit_lever_room = @install() {
            debug_subtext("S=0");

            door_act4_beam_out(0d82, 0d13);
        },
        exit_north = @install() {
            debug_subtext("S=1");

            door_act4_beam_out(0d44, 0d13);
        },
        exit_east = @install() {
            debug_subtext("S=2");

            door_act4_beam_out(0d62, 0d59);
        },
        heater_2_1_south = @install() {
            debug_subtext("S=3");

            act4_heater_touched(NORTH);
        },
        heater_2_2_north = @install() {
            debug_subtext("S=4");

            act4_heater_touched(SOUTH);
        },
        heater_1_1_2_south = @install() {
            debug_subtext("S=5");
        },
        heater_1_1_2_north = @install() {
            debug_subtext("S=6");

            act4_heater_touched(SOUTH);
        },
        heater_1_5_south = @install() {
            debug_subtext("S=7");

            act4_heater_touched(NORTH);
        },
        heater_1_5_north = @install() {
            debug_subtext("S=8");

            act4_heater_touched(SOUTH);
        },
        heater_1_3_south = @install() {
            debug_subtext("S=9");

            act4_heater_touched(NORTH);
        },

        heater_1_4_south = @install() {
            debug_subtext("S=10");

            act4_heater_touched(NORTH);
        },
        heater_1_3_north = @install() {
            debug_subtext("S=11");

            act4_heater_touched(SOUTH);
        },
        heater_1_4_north = @install() {
            debug_subtext("S=12");

            act4_heater_touched(SOUTH);
        },
        heater_2_5_north = @install() {
            debug_subtext("S=13");

            act4_heater_touched(SOUTH);
        },
        heater_2_5_south = @install() {
            debug_subtext("S=14");

            act4_heater_touched(NORTH);
        },
        heater_2_2_north = @install() {
            debug_subtext("S=15");

            act4_heater_touched(SOUTH);
        },
        heater_2_2_south = @install() {
            debug_subtext("S=16");

            act4_heater_touched(NORTH);
        },
        heater_2_3_4_north = @install() {
            debug_subtext("S=17");

            act4_heater_touched(SOUTH);
        },
        heater_2_3_4_south = @install() {
            debug_subtext("S=18");

            act4_heater_touched(NORTH);
        },
        heater_3_1_south = @install() {
            debug_subtext("S=19");

            act4_heater_touched(NORTH);
        },

        heater_3_1_north = @install() {
            debug_subtext("S=20");

            act4_heater_touched(SOUTH);
        },
        heater_3_2_south = @install() {
            debug_subtext("S=21");

            act4_heater_touched(NORTH);
        },
        heater_3_2_north = @install() {
            debug_subtext("S=22");

            act4_heater_touched(SOUTH);
        },
        heater_3_3_4_south = @install() {
            debug_subtext("S=23");

            act4_heater_touched(NORTH);
        },
        heater_3_3_4_north = @install() {
            debug_subtext("S=24");

            act4_heater_touched(SOUTH);
        },
        heater_4_3_south = @install() {
            debug_subtext("S=25");

            act4_heater_touched(NORTH);
        },
        heater_4_3_north = @install() {
            debug_subtext("S=26");

            // act4_heater_touched(SOUTH);
            act4_heater_touched(NONE);
        },
        heater_4_1_2_north = @install() {
            debug_subtext("S=27");

            // act4_heater_touched(SOUTH);
            act4_heater_touched(NONE);
        },
    }

    enum b_trigger {
        lever = @install() {
            debug_subtext("B=0");

            toggle_switch();
        },
        gourd = @install() {
            debug_subtext("B=1");
        },
    }

    fun trigger_enter() {
        // object[0x00] = 0x01; // deactivate heater_1_1
        // object[0x01] = 0x01; // deactivate heater_1_2
        // object[0x02] = 0x01; // deactivate heater_1_5
        // object[0x03] = 0x01; // deactivate heater_2_1
        // object[0x04] = 0x01; // deactivate heater_2_2
        // object[0x05] = 0x01; // deactivate heater_2_5
        // object[0x06] = 0x01; // deactivate heater_3_1
        // object[0x07] = 0x01; // deactivate heater_3_3
        // object[0x08] = 0x01; // deactivate heater_3_4
        // object[0x09] = 0x01; // deactivate heater_4_1
        // object[0x0a] = 0x01; // deactivate heater_4_2
        // object[0x0b] = 0x01; // activate fan_heater_1
        // object[0x0c] = 0x01; // activate fan_heater_2
        // object[0x0d] = 0x01; // activate fan_heater_3
        // object[0x0e] = 0x01; // activate fan_heater_4
        // object[0x0f] = 0x01; // activate fan_lever_1
        // object[0x10] = 0x01; // activate fan_lever_2
        // object[0x11] = 0x01; // activate fan_lever_3
        // object[0x12] = 0x01; // activate fan_lever_4
        // object[0x13] = 0x01; // activate machine_top_1
        // object[0x14] = 0x01; // activate machine_top_2
        // object[0x15] = 0x01; // activate machine_top_3
        // object[0x16] = 0x01; // activate machine_top_4
        // object[0x17] = 0x01; // activate machine_top_5
        // object[0x18] = 0x01; // activate machine_top_6
        // object[0x19] = 0x01; // activate machine_top_7
        // object[0x1a] = 0x01; // activate machine_top_8
        // object[0x1b] = 0x01; // activate machine_front_1
        // object[0x1c] = 0x01; // activate machine_front_2
        // object[0x1d] = 0x01; // activate machine_front_3
        // object[0x1e] = 0x01; // toggle lever
        // object[0x1f] = 0x01; // loot gourd

        fade_in();
    }
};

map control_room(OMNITOPIA_CONTROL) {
    enum entrance {
        north = entrance(0x1c, 0x0a, NONE, { door_act4_airlock_in(); }),
        east = entrance(0x54, 0x12, NONE, { door_act4_beam_in(); }),
    }

    enum stepon_trigger {
        exit_east = @install() {
            door_act4_beam_out(0d85, 0d19);

            debug_subtext("S=0");
        },
    }

    enum b_trigger {
        exit_hidden_door = @install() {
            debug_subtext("B=0");
        },
        b_trigger_1 = @install() {
            debug_subtext("B=1");
        },
        lever_3 = @install() {
            debug_subtext("B=2");
        },
        lever_2 = @install() {
            debug_subtext("B=3");
        },
        lever_1 = @install() {
            debug_subtext("B=4");
        },
        b_trigger_5 = @install() {
            debug_subtext("B=5");
        },
    }

    fun trigger_enter() {
        // object[0x00] = 0x01; // toggle lever_1
        // object[0x01] = 0x01; // toggle lever_2
        // object[0x02] = 0x7e; // change layout_hidden_door (0-9 = open space, 10-12 = open door)
        // object[0x03] = 0x01; // toggle lever_3_1
        // object[0x04] = 0x01; // toggle lever_3_2
        // object[0x05] = 0x01; // toggle lever_3_3

        fade_in();
    }
};

map face(FACE) {
    enum entrance {
        south = entrance(0x3a, 0x4e, NONE)
    }

    enum stepon_trigger {
        exit_south = @install() {
            debug_subtext("S=0");
        },
        spawn_boss = @install() {
            debug_subtext("S=1");
        }
    }

    fun trigger_enter() {
        fade_in();
    }
};

map greenhouse(OMNITOPIA_GREENHOUSE) {
    enum entrance {
        north = entrance(0x0e, 0x68, NONE),
        south = entrance(0x4c, 0x15, NONE),

        cinematic = entrance(0xfc, 0xff, NONE),
    }

    enum stepon_trigger {
        exit_north = @install() {
            debug_subtext("S=0");
        },
        exit_south = @install() {
            debug_subtext("S=1");
        },
    }

    enum b_trigger {
        gourd = @install() {
            debug_subtext("B=0");
        },
    }

    fun trigger_enter() {
        // object[0x00] = 0x01; // show lever
        // object[0x01] = 0x01; // remove flower_north_west
        // object[0x02] = 0x01; // remove flower_south_east
        // object[0x03] = 0x01; // remove flower_north
        // object[0x04] = 0x01; // remove flower_north_east
        // object[0x05] = 0x02; // loot gourd

        fade_in();
    }
};

map storage_room(OMNITOPIA_STORAGE) {
    enum entrance {
        west = entrance(0x10, 0x1a, NONE),
    }

    enum OBJECT_DEFAULT {
        DEFAULT = 0d00,
        ACTIVATED = 0d01,
    }

    enum OBJECT_GOURD_ACT4 {
        DEFAULT = 0d00,
        HALF_LOOTED = 0d01,
        LOOTED = 0d02,
    }

    enum objects {
        remove_fan_east_1_2 = object[0d07]:OBJECT_DEFAULT,
        remove_fan_east_1_4 = object[0d08]:OBJECT_DEFAULT,
        remove_fan_east_2_3 = object[0d09]:OBJECT_DEFAULT,
        remove_fan_east_2_5 = object[0d10]:OBJECT_DEFAULT,

        remove_fan_west = object[0d11]:OBJECT_DEFAULT,

        // gourds
        gourd_2_1 = object[0d04]:OBJECT_GOURD_ACT4,
        gourd_2_2 = object[0d05]:OBJECT_GOURD_ACT4,
        gourd_2_3 = object[0d06]:OBJECT_GOURD_ACT4,

        gourd_2_1 = object[0d00]:OBJECT_GOURD_ACT4,
        gourd_2_2 = object[0d01]:OBJECT_GOURD_ACT4,
        gourd_2_3 = object[0d02]:OBJECT_GOURD_ACT4,
        gourd_2_4 = object[0d03]:OBJECT_GOURD_ACT4,

        // ingredients
    }

    enum stepon_trigger {
        exit_west = @install() {
            debug_subtext("S=0");
        },
    }

    enum b_trigger {
        gourd_1_3 = @install() {
            debug_subtext("B=0");
        },
        gourd_1_2 = @install() {
            debug_subtext("B=1");
        },
        gourd_1_1 = @install() {
            debug_subtext("B=2");
        },
        gourd_2_4 = @install() {
            debug_subtext("B=3");
        },
        gourd_2_3 = @install() {
            debug_subtext("B=4");
        },
        gourd_2_2 = @install() {
            debug_subtext("B=5");
        },
        gourd_2_1 = @install() {
            debug_subtext("B=6");
        },
    }

    fun trigger_enter() {
        // object[0x00] = 0x02; // loot gourd_2_1
        // object[0x01] = 0x02; // loot gourd_2_2
        // object[0x02] = 0x02; // loot gourd_2_3
        // object[0x03] = 0x02; // loot gourd_2_4
        // object[0x04] = 0x02; // loot gourd_1_1
        // object[0x05] = 0x02; // loot gourd_1_2
        // object[0x06] = 0x02; // loot gourd_1_3
        // object[0x07] = 0x01; // remove fan_east_1_2
        // object[0x08] = 0x01; // remove fan_east_1_4
        // object[0x09] = 0x01; // remove fan_east_2_3
        // object[0x0a] = 0x01; // remove fan_east_2_5
        // object[0x0b] = 0x01; // remove fan_west

        fade_in();

        objects.gourd_2_1 = OBJECT_GOURD_ACT4.LOOTED;

        if(False) {
            MEMORY.MAP_PALETTE = MAP_PALETTE.STORAGE_ROOM_DARK;
        }
    }
};

// TODO: alarm room

map professors_lab(OMNITOPIA_PROFESSOR) {
    enum ROOM {
        DOOR_PASSAGE_SOUTH_OPEN = memory(FLAG, TEMP),
        DOOR_PASSAGE_NORTH_OPEN = memory(FLAG, TEMP),

        EVERMORE_MACHINE_LEFT = memory(WORD, TEMP),
        EVERMORE_MACHINE_RIGHT = memory(WORD, TEMP),
        EVERMORE_MACHINE_TARGET = memory(WORD, TEMP),
    }

    @install()
    @async()
    fun fake_exit_scanner(entity) {
        range_checker(entity, <ACTIVE>, 0x20, 0x20, {
            // fog_wall(NONE);

            ROOM.EVERMORE_MACHINE_TARGET = <BOY>;
            act4_evermoremachine_in(0d26, 0d88, ROOM.EVERMORE_MACHINE_LEFT, ROOM.EVERMORE_MACHINE_RIGHT);

            map_transition(professors_lab, evermore_machine, NONE);
        });
    }
    @install()
    @async()
    fun evermore_machine() {
        while(True) {
            arg[0x10] = ROOM.EVERMORE_MACHINE_TARGET;
            arg[0x12] = arg[0x10][Z] / 0d10;
            if(arg[0x12] > 0d70) {
                arg[0x12] = 0d70;
            }

            if(False) {
                debug_memory(arg[0x10], arg[0x10][Z] / 0d9);
            }
            
            if(arg[0x10] == 0x0000) {
                shoot_entity_entity(ROOM.EVERMORE_MACHINE_LEFT, LIGHTNING, ROOM.EVERMORE_MACHINE_RIGHT, 0d10, 0d10);
                sleep(0d10);

                shoot_entity_entity(ROOM.EVERMORE_MACHINE_RIGHT, LIGHTNING, ROOM.EVERMORE_MACHINE_LEFT, 0d10, 0d10);
                sleep(0d20);
            } else {
                shoot_entity_entity_offset(ROOM.EVERMORE_MACHINE_LEFT, LIGHTNING, arg[0x10], 0d0, -(arg[0x12]), 0d10, 0d10);
                sleep(0d5);

                shoot_entity_entity_offset(ROOM.EVERMORE_MACHINE_RIGHT, LIGHTNING, arg[0x10], 0d0, -(arg[0x12]), 0d10, 0d10);
                sleep(0d10);
            }
        }
    }
    fun init_evermore_machine() {
        if((ROOM.EVERMORE_MACHINE_LEFT == 0x0000) || (ROOM.EVERMORE_MACHINE_RIGHT == 0x0000)) {
            add_enemy(PLACEHOLDER, 0d24, 0d75);
            ROOM.EVERMORE_MACHINE_LEFT = <LAST_ENTITY>;
            add_enemy(PLACEHOLDER, 0d28, 0d75);
            ROOM.EVERMORE_MACHINE_RIGHT = <LAST_ENTITY>;

            evermore_machine();
        }
    }
    @install()
    @async()
    fun enter_lightning_tracker() {
        sleep(0d5);

        while(<BOY>[FLAGS_1] & ATTRIBUTE_FLAGS.DISABLED) {
            sleep(0d5);
        }

        ROOM.EVERMORE_MACHINE_TARGET = 0x0000;
    }

    enum entrance {
        north = entrance(0x3e, 0x14, NONE, { door_act4_airlock_in(0x1a); }),
        east = entrance(0x58, 0x57, NONE, { door_act4_beam_in(); }),
        west = entrance(0x1a, 0x5b, NONE),
        
        cutscene_1 = entrance(0x34, 0x59, NONE), // in front of computer
        cutscene_2 = entrance(0x3e, 0x25, NONE), // intro fight

        evermore_machine = entrance(0d26, 0d88, NONE, {
            control(NONE);

            init_evermore_machine();
            
            act4_evermoremachine_out();
            yield();
            ROOM.EVERMORE_MACHINE_TARGET = <BOY>;
            enter_lightning_tracker();
        }),
    }

    enum stepon_trigger {
        door_passage_north_north = @install() {
            debug_subtext("S=0");

            door_act4_passage(0x04, ROOM.DOOR_PASSAGE_NORTH_OPEN);
        },
        door_passage_north_south = @install() {
            debug_subtext("S=1");

            door_act4_passage(0x04, ROOM.DOOR_PASSAGE_NORTH_OPEN);
        },
        door_passage_south_north = @install() {
            debug_subtext("S=2");

            door_act4_passage(0x00, ROOM.DOOR_PASSAGE_SOUTH_OPEN);
        },
        door_passage_south_south = @install() {
            debug_subtext("S=3");

            door_act4_passage(0x00, ROOM.DOOR_PASSAGE_SOUTH_OPEN);
        },
        exit_east = @install() {
            debug_subtext("S=4");

            door_act4_beam_out(0d88, 0d87);
        },
    }

    enum b_trigger {
        gourd = @install() {
            debug_subtext("B=0");

            // _loot_chest(0x01, SPEAR_4, 0d01);
        },
        door_north = @install() {
            debug_subtext("B=1");

            door_act4_airlock_out(0d62, 0d20, 0x1a, True);
        },
        lever = @install() {
            debug_subtext("B=2");
        },
    }

    fun change_machine(color, on) {
        if(color == 0d0) {
            object[0x05] = 0x00; // remove machine_wood_west
            object[0x06] = 0x00; // remove machine_wood_south
            object[0x07] = 0x00; // remove machine_wood_east
            object[0x08] = 0x00; // change vent_1 (0 = brown+off, 1 = brown+on, 2 = grey+on)
            object[0x09] = 0x00; // change vent_2 (0 = brown+off, 1 = brown+on, 2 = grey+on)
            object[0x0a] = 0x00; // change vent_3 (0 = brown+off, 1 = brown+on, 2 = grey+on)
            object[0x0b] = 0x00; // change vent_4 (0 = brown+off, 1 = brown+on, 2 = grey+on)
            object[0x0f] = 0x00; // change vent_floor_1 (0 = brown+off, 1 = brown+on, 2 = grey+on)
            object[0x10] = 0x00; // change vent_floor_2 (0 = brown+off, 1 = brown+on, 2 = grey+on)
            object[0x11] = 0x00; // change vent_floor_3 (0 = brown+off, 1 = brown+on, 2 = grey+on)
            object[0x12] = 0x00; // change vent_floor_4 (0 = brown+off, 1 = brown+on, 2 = grey+on)
            object[0x13] = 0x00; // hide leaves_1
            object[0x14] = 0x00; // hide leaves_2
            object[0x15] = 0x00; // hide leaves_3
            object[0x16] = 0x00; // hide leaves_4
            object[0x17] = 0x00; // change machine_1 (0 = brown, 1 = grey)
            object[0x18] = 0x00; // change machine_2 (0 = brown, 1 = grey)
        } else if(color == 0d1) {
            object[0x05] = 0x01; // remove machine_wood_west
            object[0x06] = 0x01; // remove machine_wood_south
            object[0x07] = 0x01; // remove machine_wood_east
            object[0x08] = 0x02; // change vent_1 (0 = brown+off, 1 = brown+on, 2 = grey+on)
            object[0x09] = 0x02; // change vent_2 (0 = brown+off, 1 = brown+on, 2 = grey+on)
            object[0x0a] = 0x02; // change vent_3 (0 = brown+off, 1 = brown+on, 2 = grey+on)
            object[0x0b] = 0x02; // change vent_4 (0 = brown+off, 1 = brown+on, 2 = grey+on)
            object[0x0f] = 0x02; // change vent_floor_1 (0 = brown+off, 1 = brown+on, 2 = grey+on)
            object[0x10] = 0x02; // change vent_floor_2 (0 = brown+off, 1 = brown+on, 2 = grey+on)
            object[0x11] = 0x02; // change vent_floor_3 (0 = brown+off, 1 = brown+on, 2 = grey+on)
            object[0x12] = 0x02; // change vent_floor_4 (0 = brown+off, 1 = brown+on, 2 = grey+on)
            object[0x13] = 0x01; // hide leaves_1
            object[0x14] = 0x01; // hide leaves_2
            object[0x15] = 0x01; // hide leaves_3
            object[0x16] = 0x01; // hide leaves_4
            object[0x17] = 0x01; // change machine_1 (0 = brown, 1 = grey)
            object[0x18] = 0x01; // change machine_2 (0 = brown, 1 = grey)
        }

        if(on) {
            object[0x0c] = 0x01; // activate bulb_left
            object[0x0d] = 0x01; // activate bulb_right
            object[0x0e] = 0x01; // activate lights_right
            object[0x19] = 0x01; // activate lights_left
        } else {
            object[0x0c] = 0x00; // activate bulb_left
            object[0x0d] = 0x00; // activate bulb_right
            object[0x0e] = 0x00; // activate lights_right
            object[0x19] = 0x00; // activate lights_left
        }
    }

    fun trigger_enter() {
        change_machine(True, True);
        init_evermore_machine();

        add_enemy(PLACEHOLDER, 0d26, 0d88 - 0d2);
        fake_exit_scanner(<LAST_ENTITY>);

        fade_in();

        // object[0x00] = 0x7e; // open door_passage_south
        // object[0x01] = 0x7e; // open gourd
        // object[0x02] = 0x7e; // open door_floor_left
        // object[0x03] = 0x7e; // open door_floor_left
        // object[0x04] = 0x7e; // open door_passage_north

        // object[0x05] = 0x01; // remove machine_wood_west
        // object[0x06] = 0x01; // remove machine_wood_south
        // object[0x07] = 0x01; // remove machine_wood_east
        // object[0x08] = 0x02; // change vent_1 (0 = brown+off, 1 = brown+on, 2 = grey+on)
        // object[0x09] = 0x02; // change vent_2 (0 = brown+off, 1 = brown+on, 2 = grey+on)
        // object[0x0a] = 0x02; // change vent_3 (0 = brown+off, 1 = brown+on, 2 = grey+on)
        // object[0x0b] = 0x02; // change vent_4 (0 = brown+off, 1 = brown+on, 2 = grey+on)
        // object[0x0c] = 0x01; // activate bulb_left
        // object[0x0d] = 0x01; // activate bulb_right
        // object[0x0e] = 0x01; // activate lights_right
        // object[0x0f] = 0x02; // change vent_floor_1 (0 = brown+off, 1 = brown+on, 2 = grey+on)
        // object[0x10] = 0x02; // change vent_floor_2 (0 = brown+off, 1 = brown+on, 2 = grey+on)
        // object[0x11] = 0x02; // change vent_floor_3 (0 = brown+off, 1 = brown+on, 2 = grey+on)
        // object[0x12] = 0x02; // change vent_floor_4 (0 = brown+off, 1 = brown+on, 2 = grey+on)
        // object[0x13] = 0x01; // hide leaves_1
        // object[0x14] = 0x01; // hide leaves_2
        // object[0x15] = 0x01; // hide leaves_3
        // object[0x16] = 0x01; // hide leaves_4
        // object[0x17] = 0x01; // change machine_1 (0 = brown, 1 = grey)
        // object[0x18] = 0x01; // change machine_2 (0 = brown, 1 = grey)
        // object[0x19] = 0x01; // activate lights_left

        // object[0x1a] = 0x7e; // open door_north
        // object[0x1b] = 0x7e; // activate switch
    }
};

map carltron(CARLTRON) {
    enum entrance {
        center = entrance(0x14, 0x25, NONE)
    }

    enum stepon_trigger {
        stairs = @install() {
            debug_subtext("S=0");
        },
        fans = @install() {
            debug_subtext("S=1");
        }
    }

    enum b_trigger {
        b_trigger_0 = @install() {
            debug_subtext("B=0");
        },
        b_trigger_1 = @install() {
            debug_subtext("B=1");
        },
        b_trigger_2 = @install() {
            debug_subtext("B=2");
        },
        b_trigger_3 = @install() {
            debug_subtext("B=3");
        },
        b_trigger_4 = @install() {
            debug_subtext("B=4");
        },
        b_trigger_5 = @install() {
            debug_subtext("B=5");
        },
        b_trigger_6 = @install() {
            debug_subtext("B=6");
        },
        b_trigger_7 = @install() {
            debug_subtext("B=7");
        }
    }

    fun trigger_enter() {
        fade_in();
    }
};

// misc

map brians_room(BRIAN) {
    enum entrance {
        center = entrance(0x17, 0x19, NONE)
    }

    fun trigger_enter() {
        fade_in();
    }
};